<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaffolding Business Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // SVG Icons as components
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const AlertCircle = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const Users = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const FileText = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const Car = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 17h14v-3H5v3z"></path><path d="M19 10V5H5v5"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle></svg>;
        const Download = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Search = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
        const History = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></svg>;
        const Filter = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;
        const X = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;

        const API_URL = 'http://localhost:5000/api';

        function BusinessDashboard() {
            const [activeTab, setActiveTab] = useState('invoices');
            const [invoices, setInvoices] = useState([]);
            const [inquiries, setInquiries] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            // Search states
            const [invoiceSearch, setInvoiceSearch] = useState('');
            const [invoiceStatusFilter, setInvoiceStatusFilter] = useState('');
            const [invoiceYearFilter, setInvoiceYearFilter] = useState('');
            const [inquirySearch, setInquirySearch] = useState('');
            const [inquiryStatusFilter, setInquiryStatusFilter] = useState('');

            // Change history states
            const [showHistory, setShowHistory] = useState(false);
            const [changeHistory, setChangeHistory] = useState([]);
            const [historyItemId, setHistoryItemId] = useState(null);
            const [historyType, setHistoryType] = useState('');

            // Invoice data
            const [invoiceData, setInvoiceData] = useState({
                invoiceNumber: '',
                date: new Date().toISOString().split('T')[0],
                dueDate: '',
                clientName: '',
                clientAddress: '',
                clientPhone: '',
                items: [{ description: '', quantity: 1, rate: 0 }],
                notes: ''
            });

            useEffect(() => {
                loadInvoices();
            }, [invoiceSearch, invoiceStatusFilter, invoiceYearFilter]);

            useEffect(() => {
                loadInquiries();
            }, [inquirySearch, inquiryStatusFilter]);

            useEffect(() => {
                loadVehicles();
            }, []);

            const loadInvoices = async () => {
                try {
                    const params = new URLSearchParams();
                    if (invoiceSearch) params.append('search', invoiceSearch);
                    if (invoiceStatusFilter) params.append('status', invoiceStatusFilter);
                    if (invoiceYearFilter) params.append('year', invoiceYearFilter);
                    
                    const response = await fetch(`${API_URL}/invoices?${params}`);
                    const data = await response.json();
                    setInvoices(data);
                } catch (error) {
                    console.error('Error loading invoices:', error);
                    alert('Make sure the server is running! Double-click ScaffoldingManager.exe');
                }
            };

            const loadInquiries = async () => {
                try {
                    const params = new URLSearchParams();
                    if (inquirySearch) params.append('search', inquirySearch);
                    if (inquiryStatusFilter) params.append('status', inquiryStatusFilter);
                    
                    const response = await fetch(`${API_URL}/inquiries?${params}`);
                    const data = await response.json();
                    setInquiries(data);
                } catch (error) {
                    console.error('Error loading inquiries:', error);
                }
            };

            const loadVehicles = async () => {
                try {
                    const response = await fetch(`${API_URL}/vehicles`);
                    const data = await response.json();
                    setVehicles(data);
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
            };

            const viewHistory = async (itemId, type) => {
                setHistoryItemId(itemId);
                setHistoryType(type);
                setShowHistory(true);
                
                try {
                    const endpoint = type === 'invoice' ? `invoices/${itemId}/changes` : 
                                   type === 'inquiry' ? `inquiries/${itemId}/changes` : 
                                   `vehicles/${itemId}/changes`;
                    const response = await fetch(`${API_URL}/${endpoint}`);
                    const data = await response.json();
                    setChangeHistory(data);
                } catch (error) {
                    console.error('Error loading history:', error);
                    setChangeHistory([]);
                }
            };

            const getUpcomingReminders = () => {
                const today = new Date();
                const reminders = [];

                vehicles.forEach(vehicle => {
                    const checkDate = (dateStr, type, reminderDays, actioned) => {
                        if (actioned) return;
                        
                        const date = new Date(dateStr);
                        const daysUntil = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= reminderDays) {
                            let urgencyLevel = 'warning';
                            if (daysUntil <= 0) {
                                urgencyLevel = 'overdue';
                            } else if (daysUntil <= 7) {
                                urgencyLevel = 'critical';
                            }
                            
                            reminders.push({
                                vehicleId: vehicle.id,
                                vehicle: `${vehicle.registration} (${vehicle.make} ${vehicle.model})`,
                                type,
                                date: dateStr,
                                daysUntil,
                                urgencyLevel,
                                actionField: type === 'MOT' ? 'motActioned' : type === 'Tax' ? 'taxActioned' : 'insuranceActioned'
                            });
                        }
                    };

                    checkDate(vehicle.motDue, 'MOT', 30, vehicle.motActioned);
                    checkDate(vehicle.taxDue, 'Tax', 7, vehicle.taxActioned);
                    checkDate(vehicle.insuranceDue, 'Insurance', 60, vehicle.insuranceActioned);
                });

                return reminders.sort((a, b) => {
                    if (a.daysUntil < 0 && b.daysUntil >= 0) return -1;
                    if (b.daysUntil < 0 && a.daysUntil >= 0) return 1;
                    return a.daysUntil - b.daysUntil;
                });
            };

            const markAsActioned = async (vehicleId, actionField) => {
                try {
                    const vehicle = vehicles.find(v => v.id === vehicleId);
                    const updateData = { ...vehicle, [actionField]: true };
                    
                    await fetch(`${API_URL}/vehicles/${vehicleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    loadVehicles();
                } catch (error) {
                    console.error('Error updating vehicle:', error);
                }
            };

            const calculateTotal = () => {
                const subtotal = invoiceData.items.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                const vat = subtotal * 0.20;
                const total = subtotal + vat;
                return { subtotal, vat, total };
            };

            const currentYear = new Date().getFullYear();
            const yearOptions = Array.from({ length: 11 }, (_, i) => currentYear - i);
            const upcomingReminders = getUpcomingReminders();

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
                    <div className="container mx-auto p-6">
                        <div className="mb-8">
                            <h1 className="text-4xl font-bold text-slate-800 mb-2">üèóÔ∏è Scaffolding Business Manager</h1>
                            <p className="text-slate-600">Complete business management system</p>
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-slate-600 text-sm">Total Invoices</p>
                                        <p className="text-2xl font-bold text-slate-800">{invoices.length}</p>
                                    </div>
                                    <FileText />
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-slate-600 text-sm">New Inquiries</p>
                                        <p className="text-2xl font-bold text-slate-800">{inquiries.filter(i => i.status === 'new').length}</p>
                                    </div>
                                    <Users />
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-slate-600 text-sm">Active Reminders</p>
                                        <p className="text-2xl font-bold text-slate-800">{upcomingReminders.length}</p>
                                    </div>
                                    <AlertCircle />
                                </div>
                            </div>
                        </div>

                        {/* Reminders Alert */}
                        {upcomingReminders.length > 0 && (
                            <div className="bg-orange-50 border-l-4 border-orange-500 p-4 mb-8 rounded-lg shadow">
                                <div className="flex items-start">
                                    <AlertCircle />
                                    <div className="flex-1 ml-3">
                                        <h3 className="font-bold text-orange-800 mb-3">‚ö†Ô∏è Vehicle Reminders - Action Required</h3>
                                        <div className="space-y-3">
                                            {upcomingReminders.map((reminder, idx) => (
                                                <div 
                                                    key={idx} 
                                                    className={`p-3 rounded-lg border ${
                                                        reminder.urgencyLevel === 'overdue' 
                                                            ? 'bg-red-100 border-red-300' 
                                                            : reminder.urgencyLevel === 'critical'
                                                            ? 'bg-orange-100 border-orange-300'
                                                            : 'bg-yellow-50 border-yellow-300'
                                                    }`}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            <p className="font-semibold text-slate-800">
                                                                {reminder.vehicle} - {reminder.type}
                                                            </p>
                                                            <p className={`text-sm font-semibold ${
                                                                reminder.urgencyLevel === 'overdue' 
                                                                    ? 'text-red-700' 
                                                                    : reminder.urgencyLevel === 'critical'
                                                                    ? 'text-orange-700'
                                                                    : 'text-yellow-700'
                                                            }`}>
                                                                {reminder.daysUntil < 0 
                                                                    ? `‚ö†Ô∏è OVERDUE by ${Math.abs(reminder.daysUntil)} days!` 
                                                                    : `Due in ${reminder.daysUntil} days (${reminder.date})`}
                                                            </p>
                                                        </div>
                                                        <button
                                                            onClick={() => markAsActioned(reminder.vehicleId, reminder.actionField)}
                                                            className="ml-3 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition font-semibold"
                                                        >
                                                            ‚úì Done
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <p className="text-xs text-orange-600 mt-3 italic">
                                            üí° MOT (30 days) ‚Ä¢ Insurance (60 days) ‚Ä¢ Tax (7 days)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Main Content */}
                        <div className="bg-white rounded-lg shadow">
                            {/* Tabs */}
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('invoices')}
                                    className={`flex-1 py-4 px-6 font-semibold transition flex items-center justify-center ${
                                        activeTab === 'invoices'
                                            ? 'border-b-2 border-blue-500 text-blue-600'
                                            : 'text-slate-600 hover:text-slate-800'
                                    }`}
                                >
                                    <FileText /> <span className="ml-2">Invoices</span>
                                </button>
                                <button
                                    onClick={() => setActiveTab('inquiries')}
                                    className={`flex-1 py-4 px-6 font-semibold transition flex items-center justify-center ${
                                        activeTab === 'inquiries'
                                            ? 'border-b-2 border-blue-500 text-blue-600'
                                            : 'text-slate-600 hover:text-slate-800'
                                    }`}
                                >
                                    <Users /> <span className="ml-2">Inquiries</span>
                                </button>
                                <button
                                    onClick={() => setActiveTab('vehicles')}
                                    className={`flex-1 py-4 px-6 font-semibold transition flex items-center justify-center ${
                                        activeTab === 'vehicles'
                                            ? 'border-b-2 border-blue-500 text-blue-600'
                                            : 'text-slate-600 hover:text-slate-800'
                                    }`}
                                >
                                    <Car /> <span className="ml-2">Vehicles</span>
                                </button>
                            </div>

                            {/* Tab Content */}
                            <div className="p-6">
                                {activeTab === 'invoices' && (
                                    <div className="text-center py-8">
                                        <h3 className="text-2xl font-bold text-slate-800 mb-4">Invoice Management</h3>
                                        <p className="text-slate-600 mb-4">Search, create, and manage all your invoices</p>
                                        <p className="text-sm text-slate-500">Found {invoices.length} invoices</p>
                                    </div>
                                )}

                                {activeTab === 'inquiries' && (
                                    <div className="text-center py-8">
                                        <h3 className="text-2xl font-bold text-slate-800 mb-4">Customer Inquiries</h3>
                                        <p className="text-slate-600 mb-4">Track scaffolding requests and quotes</p>
                                        <p className="text-sm text-slate-500">Found {inquiries.length} inquiries</p>
                                    </div>
                                )}

                                {activeTab === 'vehicles' && (
                                    <div className="text-center py-8">
                                        <h3 className="text-2xl font-bold text-slate-800 mb-4">Vehicle Reminders</h3>
                                        <p className="text-slate-600 mb-4">MOT, Tax, and Insurance tracking</p>
                                        <p className="text-sm text-slate-500">Managing {vehicles.length} vehicles</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-8 text-slate-500 text-sm">
                            <p>Scaffolding Business Manager ‚Ä¢ All data stored locally</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BusinessDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
