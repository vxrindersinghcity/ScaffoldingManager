<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khalsa Scaffolding - Business Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-primary);
            color: var(--primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .nav-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
        }

        .page-header {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .date-time-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }

        .link-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-badge:hover {
            background: var(--primary-dark);
        }

        .area-tag {
            display: inline-block;
            padding: 4px 12px;
            background: var(--info);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border-left: 4px solid var(--warning);
            margin-bottom: 12px;
        }

        .reminder-item.urgent {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, var(--bg-primary) 100%);
        }

        .reminder-item.overdue {
            border-left-color: #dc2626;
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.1) 0%, var(--bg-primary) 100%);
        }

        .info-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .checkbox-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .bulk-actions-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        /* --- NEW VEHICLE STYLES --- */
        .date-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Color classes for dot and text */
        .dot-green { background-color: #10b981; }
        .date-safe { color: #10b981; } /* Green */

        .dot-yellow { background-color: #f59e0b; }
        .date-warning { color: #f59e0b; } /* Yellow (15-30 days) */

        .dot-orange { background-color: #f97316; }
        .date-orange { color: #f97316; } /* Orange (8-14 days) */

        .dot-red { background-color: #ef4444; }
        .date-danger { color: #ef4444; } /* Red (1-7 days/Today) */

        .dot-darkred { background-color: #dc2626; }
        .date-overdue { color: #dc2626; } /* Dark Red */

        .date-na {
            color: var(--text-secondary);
        }
        /* --- END NEW VEHICLE STYLES --- */
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://127.0.0.1:5000/api';

        // Load areas from localStorage or use defaults
        const loadAreas = () => {
            const saved = localStorage.getItem('scaffolding_areas');
            return saved ? JSON.parse(saved) : ['Peterborough', 'Leicester', 'London', 'Birmingham', 'Unassigned'];
        };

        const saveAreas = (areas) => {
            localStorage.setItem('scaffolding_areas', JSON.stringify(areas));
        };

        /**
         * Determines the color, days until due, and status for a vehicle date.
         * Logic:
         * < 0 days: Overdue (Dark Red)
         * 0-7 days: Urgent (Red)
         * 8-14 days: Warning (Orange)
         * 15-30 days: Warning (Yellow)
         * > 30 days: Safe (Green)
         */
        function getDateIndicatorData(dateStr, actioned) {
            if (!dateStr) {
                return { status: 'N/A', daysUntil: null, colorClass: 'date-na', dotColor: 'bg-gray-400' };
            }
            // If actioned, treat as safe/completed, ignore days left.
            if (actioned) {
                return { status: 'Actioned', daysUntil: null, colorClass: 'date-safe', dotColor: 'dot-green' };
            }

            const today = new Date();
            const dueDate = new Date(dateStr);
            dueDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntil < 0) {
                return { status: 'Overdue', daysUntil, colorClass: 'date-overdue', dotColor: 'dot-darkred' };
            } else if (daysUntil >= 0 && daysUntil <= 7) {
                return { status: 'Urgent', daysUntil, colorClass: 'date-danger', dotColor: 'dot-red' };
            } else if (daysUntil >= 8 && daysUntil <= 14) {
                return { status: 'Warning (Orange)', daysUntil, colorClass: 'date-orange', dotColor: 'dot-orange' };
            } else if (daysUntil >= 15 && daysUntil <= 30) {
                return { status: 'Warning (Yellow)', daysUntil, colorClass: 'date-warning', dotColor: 'dot-yellow' };
            } else {
                return { status: 'Safe', daysUntil, colorClass: 'date-safe', dotColor: 'dot-green' };
            }
        }


        function App() {
            const [activeView, setActiveView] = useState('dashboard');
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [currentDateTime, setCurrentDateTime] = useState(new Date());
            const [areas, setAreas] = useState(loadAreas());

            const [invoices, setInvoices] = useState([]);
            const [inquiries, setInquiries] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [jobs, setJobs] = useState([]);

            useEffect(() => {
                loadData();
                const timer = setInterval(() => {
                    setCurrentDateTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Save areas whenever they change
            useEffect(() => {
                saveAreas(areas);
            }, [areas]);

            const loadData = async () => {
                try {
                    const [invRes, inqRes, vehRes, jobRes] = await Promise.all([
                        fetch(`${API_URL}/invoices`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/inquiries`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/vehicles`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/jobs`).catch(() => ({ json: async () => [] }))
                    ]);
                    setInvoices(await invRes.json());
                    setInquiries(await inqRes.json());
                    setVehicles(await vehRes.json());
                    const jobsData = await jobRes.json();
                    const processedJobs = jobsData.map(job => ({
                        ...job,
                        area: (job.area && areas.includes(job.area)) ? job.area : 'Unassigned'
                    }));
                    setJobs(processedJobs);
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const openModal = (type, item = null) => {
                setModalType(type);
                setEditingItem(item);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setModalType('');
                setEditingItem(null);
            };

            function getVehicleReminders(vehicles) {
                const today = new Date();
                const reminders = [];

                vehicles.forEach(vehicle => {
                    const checkDate = (dateStr, type, advanceDays, actioned) => {
                        if (!dateStr || actioned) return;

                        const dueDate = new Date(dateStr);
                        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                        if (daysUntil <= advanceDays) {
                            const vehicleLabel = vehicle.vehicleType === 'truck' ? 'üöö' : 'üöó';
                            reminders.push({
                                vehicleId: vehicle.id,
                                vehicle: `${vehicleLabel} ${vehicle.registration}`,
                                owner: vehicle.ownerName,
                                type: type,
                                dueDate: dateStr,
                                daysUntil: daysUntil,
                                isOverdue: daysUntil < 0,
                                isUrgent: daysUntil <= 7 && daysUntil >= 0,
                                actionField: type === 'MOT' ? 'motActioned' :
                                    type === 'Tax' ? 'taxActioned' :
                                        type === 'Tacho' ? 'tachoActioned' :
                                            type === 'Maintenance' ? 'maintenanceActioned' :
                                                'insuranceActioned',
                                needsReset: type === 'Maintenance'
                            });
                        }
                    };

                    // Reminders are configured based on a fixed number of days for the dashboard
                    checkDate(vehicle.motDue, 'MOT', 30, vehicle.motActioned);
                    checkDate(vehicle.taxDue, 'Tax', 14, vehicle.taxActioned);
                    checkDate(vehicle.insuranceDue, 'Insurance', 60, vehicle.insuranceActioned);

                    if (vehicle.vehicleType === 'truck') {
                        checkDate(vehicle.tachoDue, 'Tacho', 30, vehicle.tachoActioned);
                        checkDate(vehicle.maintenanceDue, 'Maintenance', 7, vehicle.maintenanceActioned);
                    }
                });

                return reminders.sort((a, b) => a.daysUntil - b.daysUntil);
            }

            function getFutureJobs(jobs) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return jobs.filter(job => {
                    if (!job.startDate) return false;
                    const startDate = new Date(job.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    return startDate > today && job.status !== 'cancelled' && job.status !== 'completed';
                }).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            }

            const stats = {
                totalRevenue: invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (parseFloat(inv.total) || 0), 0),
                pendingInvoices: invoices.filter(inv => inv.status === 'pending').length,
                activeJobs: jobs.filter(job => job.status === 'active').length,
                newInquiries: inquiries.filter(inq => inq.status === 'new').length,
                vehicleReminders: getVehicleReminders(vehicles).length,
                futureJobs: getFutureJobs(jobs).length
            };

            const formatDateTime = (date) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();

                let hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;

                return `${dayName}, ${day} ${month} ${year} ‚Ä¢ ${hours}:${minutes}:${seconds} ${ampm}`;
            };

            return (
                <div className="app-container">
                    <Sidebar
                        activeView={activeView}
                        setActiveView={setActiveView}
                        stats={stats}
                    />
                    <main className="main-content">
                        {activeView === 'dashboard' && (
                            <Dashboard
                                stats={stats}
                                invoices={invoices}
                                vehicles={vehicles}
                                jobs={jobs}
                                openModal={openModal}
                                setActiveView={setActiveView}
                                loadData={loadData}
                                currentDateTime={currentDateTime}
                                formatDateTime={formatDateTime}
                                getVehicleReminders={getVehicleReminders}
                            />
                        )}
                        {activeView === 'invoices' && (
                            <InvoicesView
                                invoices={invoices}
                                jobs={jobs}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'inquiries' && (
                            <InquiriesView
                                inquiries={inquiries}
                                jobs={jobs}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'jobs' && (
                            <JobsView
                                jobs={jobs}
                                invoices={invoices}
                                inquiries={inquiries}
                                vehicles={vehicles}
                                openModal={openModal}
                                loadData={loadData}
                                areas={areas}
                            />
                        )}
                        {activeView === 'vehicles' && (
                            <VehiclesView
                                vehicles={vehicles}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'settings' && (
                            <SettingsView
                                areas={areas}
                                setAreas={setAreas}
                                jobs={jobs}
                                loadData={loadData}
                            />
                        )}
                    </main>

                    {showModal && (
                        <Modal
                            type={modalType}
                            item={editingItem}
                            closeModal={closeModal}
                            loadData={loadData}
                            jobs={jobs}
                            inquiries={inquiries}
                            invoices={invoices}
                            vehicles={vehicles}
                            areas={areas}
                        />
                    )}
                </div>
            );
        }

        function Sidebar({ activeView, setActiveView, stats }) {
            return (
                <aside className="sidebar">
                    <div className="sidebar-header">
                        <div className="logo">
                            <div className="logo-icon">üèóÔ∏è</div>
                            <div>
                                <h1 style={{ fontSize: '18px', fontWeight: 700 }}>Khalsa Scaffolding</h1>
                                <p style={{ fontSize: '12px', opacity: 0.9 }}>Business Manager</p>
                            </div>
                        </div>
                    </div>

                    <nav className="sidebar-nav">
                        <div className={`nav-item ${activeView === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveView('dashboard')}>
                            <span>üìä</span>
                            <span>Dashboard</span>
                        </div>
                        <div className={`nav-item ${activeView === 'invoices' ? 'active' : ''}`} onClick={() => setActiveView('invoices')}>
                            <span>üìÑ</span>
                            <span>Invoices</span>
                        </div>
                        <div className={`nav-item ${activeView === 'inquiries' ? 'active' : ''}`} onClick={() => setActiveView('inquiries')}>
                            <span>üí¨</span>
                            <span>Inquiries</span>
                            {stats.newInquiries > 0 && <span className="nav-badge">{stats.newInquiries}</span>}
                        </div>
                        <div className={`nav-item ${activeView === 'jobs' ? 'active' : ''}`} onClick={() => setActiveView('jobs')}>
                            <span>üî®</span>
                            <span>Jobs</span>
                        </div>
                        <div className={`nav-item ${activeView === 'vehicles' ? 'active' : ''}`} onClick={() => setActiveView('vehicles')}>
                            <span>üöó</span>
                            <span>Vehicles</span>
                            {stats.vehicleReminders > 0 && <span className="nav-badge">{stats.vehicleReminders}</span>}
                        </div>
                        <div className={`nav-item ${activeView === 'settings' ? 'active' : ''}`} onClick={() => setActiveView('settings')}>
                            <span>‚öôÔ∏è</span>
                            <span>Settings</span>
                        </div>
                    </nav>
                </aside>
            );
        }

        function Dashboard({ stats, invoices, vehicles, jobs, openModal, setActiveView, loadData, currentDateTime, formatDateTime, getVehicleReminders }) {
            const reminders = getVehicleReminders(vehicles);
            const futureJobs = jobs.filter(job => {
                if (!job.startDate) return false;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDate = new Date(job.startDate);
                startDate.setHours(0, 0, 0, 0);
                return startDate > today && job.status !== 'cancelled' && job.status !== 'completed';
            }).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            const markVehicleActioned = async (reminder) => {
                const vehicle = vehicles.find(v => v.id === reminder.vehicleId);
                if (!vehicle) return;

                try {
                    let updatedVehicle = { ...vehicle, [reminder.actionField]: true };

                    if (reminder.needsReset && reminder.type === 'Maintenance') {
                        // For Maintenance: Automatically calculate next date (8 weeks) and reset actioned status
                        const currentDate = reminder.dueDate ? new Date(reminder.dueDate) : new Date(); // Use existing due date or today if missing
                        const nextDate = new Date(currentDate);
                        nextDate.setDate(nextDate.getDate() + 56);

                        const nextDateStr = nextDate.toISOString().split('T')[0];
                        updatedVehicle.maintenanceDue = nextDateStr;
                        updatedVehicle.maintenanceActioned = false; // Reset status for the new date

                        if (confirm(`Maintenance completed! Next maintenance will be due on ${nextDate.toLocaleDateString('en-GB')} (8 weeks from now). Continue?`)) {
                            await fetch(`${API_URL}/vehicles/${reminder.vehicleId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedVehicle)
                            });
                            loadData();
                            alert('‚úÖ Maintenance marked complete and next date set!');
                        }
                    } else {
                        // For all others: Just mark actioned as true
                        await fetch(`${API_URL}/vehicles/${reminder.vehicleId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updatedVehicle)
                        });
                        loadData();
                        alert(`‚úÖ ${reminder.type} for ${reminder.vehicle} marked as Actioned!`);
                    }
                } catch (error) {
                    alert('‚ùå Error updating vehicle');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                            <div>
                                <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Dashboard</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Welcome back! Here's what's happening with your business.</p>
                            </div>
                        </div>
                        <div className="date-time-display">
                            <span>üïê</span>
                            <span>{formatDateTime(currentDateTime)}</span>
                        </div>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px' }}>TOTAL REVENUE</div>
                                    <div style={{ fontSize: '36px', fontWeight: 700 }}>¬£{stats.totalRevenue.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                                <div style={{ fontSize: '48px' }}>üí∞</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{ '--primary': 'var(--warning)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px' }}>PENDING INVOICES</div>
                                    <div style={{ fontSize: '36px', fontWeight: 700 }}>{stats.pendingInvoices}</div>
                                </div>
                                <div style={{ fontSize: '48px' }}>‚è≥</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{ '--primary': 'var(--success)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px' }}>ACTIVE JOBS</div>
                                    <div style={{ fontSize: '36px', fontWeight: 700 }}>{stats.activeJobs}</div>
                                </div>
                                <div style={{ fontSize: '48px' }}>üî®</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{ '--primary': 'var(--danger)' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px' }}>NEW INQUIRIES</div>
                                    <div style={{ fontSize: '36px', fontWeight: 700 }}>{stats.newInquiries}</div>
                                </div>
                                <div style={{ fontSize: '48px' }}>üí¨</div>
                            </div>
                        </div>
                    </div>

                    {reminders.length > 0 && (
                        <div className="section">
                            <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üö® Vehicle Reminders</h2>
                            <div>
                                {reminders.map((reminder, idx) => (
                                    <div key={idx} className={`reminder-item ${reminder.isOverdue ? 'overdue' : reminder.isUrgent ? 'urgent' : ''}`}>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontWeight: 600, marginBottom: '4px' }}>
                                                {reminder.vehicle} - {reminder.type} Due
                                                {reminder.type === 'Maintenance' && ' (8-week cycle)'}
                                            </div>
                                            <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                                Owner: {reminder.owner} ‚Ä¢ Due: {new Date(reminder.dueDate).toLocaleDateString('en-GB')}
                                            </div>
                                        </div>
                                        <div style={{
                                            padding: '6px 12px',
                                            background: 'white',
                                            borderRadius: '6px',
                                            fontWeight: 600,
                                            color: reminder.isOverdue ? '#dc2626' : reminder.isUrgent ? 'var(--danger)' : 'var(--warning)'
                                        }}>
                                            {reminder.isOverdue ? `${Math.abs(reminder.daysUntil)} days overdue` :
                                                reminder.daysUntil === 0 ? 'Today' :
                                                    reminder.daysUntil === 1 ? 'Tomorrow' :
                                                        `${reminder.daysUntil} days`}
                                        </div>
                                        <button
                                            className="btn btn-success btn-sm"
                                            onClick={() => markVehicleActioned(reminder)}
                                        >
                                            ‚úì Done
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {futureJobs.length > 0 && (
                        <div className="section">
                            <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üìÖ Upcoming Jobs</h2>
                            <div>
                                {futureJobs.slice(0, 5).map((job, idx) => {
                                    const startDate = new Date(job.startDate);
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);
                                    startDate.setHours(0, 0, 0, 0);
                                    const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                                    
                                    return (
                                        <div key={idx} className="reminder-item" style={{ background: '#f0f9ff', borderLeft: '4px solid #3b82f6' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontWeight: 600, marginBottom: '4px' }}>
                                                    {job.jobNumber} - {job.clientName}
                                                </div>
                                                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                                    Location: {job.location} {job.area && `(${job.area})`}
                                                    {job.truck && ` ‚Ä¢ Truck: ${job.truck}`}
                                                    {job.driver && ` ‚Ä¢ Driver: ${job.driver}`}
                                                </div>
                                            </div>
                                            <div style={{
                                                padding: '6px 12px',
                                                background: 'white',
                                                borderRadius: '6px',
                                                fontWeight: 600,
                                                color: daysUntil <= 3 ? '#dc2626' : daysUntil <= 7 ? 'var(--warning)' : '#3b82f6'
                                            }}>
                                                {daysUntil === 0 ? 'Today' :
                                                    daysUntil === 1 ? 'Tomorrow' :
                                                        `In ${daysUntil} days`}
                                            </div>
                                            <button
                                                className="btn btn-secondary btn-sm"
                                                onClick={() => openModal('job', job)}
                                            >
                                                üìù View
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                            {futureJobs.length > 5 && (
                                <div style={{ marginTop: '16px', textAlign: 'center' }}>
                                    <button className="btn btn-secondary btn-sm" onClick={() => setActiveView('jobs')}>
                                        View All {futureJobs.length} Upcoming Jobs ‚Üí
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    <div className="section">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>üìã Recent Invoices</h2>
                            <button className="btn btn-secondary btn-sm" onClick={() => setActiveView('invoices')}>
                                View All ‚Üí
                            </button>
                        </div>
                        {invoices.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {invoices.slice(0, 5).map(inv => (
                                        <tr key={inv.id}>
                                            <td><strong>{inv.invoiceNumber}</strong></td>
                                            <td>{inv.clientName}</td>
                                            <td>{new Date(inv.date).toLocaleDateString('en-GB')}</td>
                                            <td>
                                                <div>
                                                    <strong>¬£{(inv.total || 0).toLocaleString()}</strong>
                                                    {inv.vatApplied !== false && inv.vat > 0 && (
                                                        <div style={{ fontSize: '10px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                                            ¬£{(inv.subtotal || 0).toLocaleString()} + ¬£{(inv.vat || 0).toLocaleString()} VAT
                                                        </div>
                                                    )}
                                                    {inv.vatApplied === false && (
                                                        <div style={{ fontSize: '10px', color: 'var(--warning)', marginTop: '2px' }}>
                                                            No VAT
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                            <td>
                                                <span className={`badge badge-${inv.status === 'paid' ? 'success' : 'warning'}`}>
                                                    {inv.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                                No invoices yet. Create your first invoice to get started!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function InvoicesView({ invoices, jobs, openModal, loadData }) {
            const deleteInvoice = async (id) => {
                if (!confirm('Are you sure you want to delete this invoice?')) return;
                try {
                    await fetch(`${API_URL}/invoices/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Invoice deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting invoice');
                }
            };

            const updateStatus = async (id, newStatus) => {
                const invoice = invoices.find(inv => inv.id === id);
                if (!invoice) return;
                try {
                    await fetch(`${API_URL}/invoices/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...invoice, status: newStatus })
                    });
                    loadData();
                } catch (error) {
                    alert('‚ùå Error updating status');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Invoices</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Manage all your invoices and billing</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('invoice')}>
                                ‚ûï New Invoice
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üìÑ All Invoices</h2>
                        {invoices.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Linked Job</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {invoices.map(inv => (
                                        <tr key={inv.id}>
                                            <td><strong>{inv.invoiceNumber}</strong></td>
                                            <td>{inv.clientName}</td>
                                            <td>{new Date(inv.date).toLocaleDateString('en-GB')}</td>
                                            <td>
                                                <div>
                                                    <strong>¬£{(inv.total || 0).toLocaleString()}</strong>
                                                    {inv.vatApplied !== false && inv.vat > 0 && (
                                                        <div style={{ fontSize: '10px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                                            ¬£{(inv.subtotal || 0).toLocaleString()} + ¬£{(inv.vat || 0).toLocaleString()} VAT
                                                        </div>
                                                    )}
                                                    {inv.vatApplied === false && (
                                                        <div style={{ fontSize: '10px', color: 'var(--warning)', marginTop: '2px' }}>
                                                            No VAT
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                            <td>
                                                <select
                                                    value={inv.status}
                                                    onChange={(e) => updateStatus(inv.id, e.target.value)}
                                                    className="form-select"
                                                    style={{ width: 'auto', padding: '4px 8px', fontSize: '12px' }}
                                                >
                                                    <option value="pending">Pending</option>
                                                    <option value="paid">Paid</option>
                                                    <option value="overdue">Overdue</option>
                                                </select>
                                            </td>
                                            <td>
                                                {inv.linkedJobId ? (
                                                    <span className="link-badge">
                                                        üîó Job #{inv.linkedJobId}
                                                    </span>
                                                ) : (
                                                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>-</span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('invoice', inv)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button 
                                                        className="btn btn-sm btn-primary" 
                                                        onClick={() => window.open(`${API_URL}/invoices/${inv.id}/preview`, '_blank')}
                                                        title="Download Excel Invoice"
                                                    >
                                                        üìä
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteInvoice(inv.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                                No invoices yet. Create your first invoice!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function InquiriesView({ inquiries, jobs, openModal, loadData }) {
            const deleteInquiry = async (id) => {
                if (!confirm('Are you sure you want to delete this inquiry?')) return;
                try {
                    await fetch(`${API_URL}/inquiries/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Inquiry deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting inquiry');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Inquiries</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Track and manage customer inquiries</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('inquiry')}>
                                ‚ûï New Inquiry
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üí¨ All Inquiries</h2>
                        {inquiries.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Location</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Linked Job</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {inquiries.map(inq => (
                                        <tr key={inq.id}>
                                            <td><strong>{inq.name}</strong></td>
                                            <td>{inq.phone}</td>
                                            <td>{inq.location}</td>
                                            <td>{new Date(inq.date).toLocaleDateString('en-GB')}</td>
                                            <td>
                                                <span className={`badge badge-${inq.status === 'new' ? 'danger' :
                                                        inq.status === 'contacted' ? 'warning' :
                                                            inq.status === 'quoted' ? 'info' : 'success'
                                                    }`}>
                                                    {inq.status}
                                                </span>
                                            </td>
                                            <td>
                                                {inq.linkedJobId ? (
                                                    <span className="link-badge">
                                                        üîó Job #{inq.linkedJobId}
                                                    </span>
                                                ) : (
                                                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>-</span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('inquiry', inq)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteInquiry(inq.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                                No inquiries yet. Add your first inquiry!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function JobsView({ jobs, openModal, loadData, areas }) {
            const [searchText, setSearchText] = useState('');
            const [selectedStatus, setSelectedStatus] = useState('all');
            
            const updateJobStatus = async (jobId, newStatus) => {
                const job = jobs.find(j => j.id === jobId);
                if (!job) return;
                try {
                    await fetch(`${API_URL}/jobs/${jobId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...job, status: newStatus })
                    });
                    loadData();
                } catch (error) {
                    alert('‚ùå Error updating status');
                }
            };
            const [selectedArea, setSelectedArea] = useState('all');
            const [sortField, setSortField] = useState('date');
            const [sortDirection, setSortDirection] = useState('asc');
            const [selectedJobs, setSelectedJobs] = useState([]);


            const searchFiltered = jobs.filter(job => {
                const searchLower = searchText.toLowerCase();
                
                // Extract year and month from dates for searching
                let startYear = '', startMonth = '', endYear = '', endMonth = '';
                if (job.startDate) {
                    const startDate = new Date(job.startDate);
                    startYear = startDate.getFullYear().toString();
                    startMonth = startDate.toLocaleDateString('en-GB', { month: 'long' }).toLowerCase();
                }
                if (job.endDate) {
                    const endDate = new Date(job.endDate);
                    endYear = endDate.getFullYear().toString();
                    endMonth = endDate.toLocaleDateString('en-GB', { month: 'long' }).toLowerCase();
                }
                
                // üîç Search bar - searches job number, client, location, area, truck, driver, notes, year, month
                return (
                    (job.jobNumber && job.jobNumber.toLowerCase().includes(searchLower)) ||
                    (job.clientName && job.clientName.toLowerCase().includes(searchLower)) ||
                    (job.location && job.location.toLowerCase().includes(searchLower)) ||
                    (job.area && job.area.toLowerCase().includes(searchLower)) ||
                    (job.truck && job.truck.toLowerCase().includes(searchLower)) ||
                    (job.driver && job.driver.toLowerCase().includes(searchLower)) ||
                    (job.notes && job.notes.toLowerCase().includes(searchLower)) ||
                    startYear.includes(searchLower) ||
                    endYear.includes(searchLower) ||
                    startMonth.includes(searchLower) ||
                    endMonth.includes(searchLower)
                );
            });

            const statusFiltered = selectedStatus === 'all'
                ? searchFiltered
                : searchFiltered.filter(job => job.status === selectedStatus);

            const areaFiltered = selectedArea === 'all'
                ? statusFiltered
                : statusFiltered.filter(job => job.area === selectedArea);

            const filteredJobs = areaFiltered.sort((a, b) => {
                if (sortField === 'date') {
                    const dateA = new Date(a.startDate || 0);
                    const dateB = new Date(b.startDate || 0);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                } else if (sortField === 'client') {
                    return sortDirection === 'asc' ? a.clientName.localeCompare(b.clientName) : b.clientName.localeCompare(a.clientName);
                } else if (sortField === 'value') {
                    return sortDirection === 'asc' ? (a.value || 0) - (b.value || 0) : (b.value || 0) - (a.value || 0);
                } else if (sortField === 'status') {
                    return sortDirection === 'asc' ? a.status.localeCompare(b.status) : b.status.localeCompare(a.status);
                }
                return 0;
            });

            const deleteJob = async (id) => {
                if (!confirm('Are you sure you want to delete this job?')) return;
                try {
                    await fetch(`${API_URL}/jobs/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Job deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting job');
                }
            };

            const toggleJobSelection = (jobId) => {
                setSelectedJobs(prev => prev.includes(jobId) ? prev.filter(id => id !== jobId) : [...prev, jobId]
                );
            };

            const toggleSelectAll = () => {
                if (selectedJobs.length === filteredJobs.length) {
                    setSelectedJobs([]);
                } else {
                    setSelectedJobs(filteredJobs.map(j => j.id));
                }
            };

            const bulkDeleteJobs = async () => {
                if (selectedJobs.length === 0) {
                    alert('Please select jobs to delete');
                    return;
                }
                if (!confirm(`Are you sure you want to delete ${selectedJobs.length} job(s)?`)) return;
                try {
                    await fetch(`${API_URL}/jobs/bulk-delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: selectedJobs })
                    });
                    setSelectedJobs([]);
                    loadData();
                    alert('‚úÖ Jobs deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting jobs');
                }
            };

            const getStatusBadge = (status) => {
                switch (status) {
                    case 'active':
                        return <span className="badge badge-success">Active</span>;
                    case 'completed':
                        return <span className="badge badge-info">Completed</span>;
                    case 'cancelled':
                        return <span className="badge badge-danger">Cancelled</span>;
                    case 'pending':
                    default:
                        return <span className="badge badge-warning">Pending</span>;
                }
            }

            return (
                <>
                    <div className="page-header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Jobs</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Manage all current, past, and future scaffolding jobs</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('job')}>
                                ‚ûï New Job
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üî® All Jobs</h2>

                        {/* Search, Filter, Sort Controls */}
                        <div style={{ marginBottom: '24px', borderBottom: '1px solid var(--border)', paddingBottom: '16px' }}>
                            {/* Search */}
                            <input
                                type="text"
                                className="form-input"
                                placeholder="üîç Search job number, client, location, area, truck, driver, year, month, notes..."
                                value={searchText}
                                onChange={(e) => setSearchText(e.target.value)}
                                style={{ marginBottom: '16px' }}
                            />

                            <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                                {/* Status Filter */}
                                <select
                                    className="form-select"
                                    value={selectedStatus}
                                    onChange={(e) => setSelectedStatus(e.target.value)}
                                    style={{ width: '180px' }}
                                >
                                    <option value="all">üìä All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>

                                {/* Sort Options */}
                                <select
                                    className="form-select"
                                    value={sortField}
                                    onChange={(e) => setSortField(e.target.value)}
                                    style={{ width: '200px' }}
                                >
                                    <option value="date">üî¢ Sort by Date</option>
                                    <option value="client">Sort by Client</option>
                                    <option value="value">Sort by Value</option>
                                    <option value="status">Sort by Status</option>
                                </select>
                                <button className="btn btn-secondary btn-sm" onClick={() => setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')} >
                                    {sortDirection === 'asc' ? '‚¨ÜÔ∏è Asc' : '‚¨áÔ∏è Desc'}
                                </button>
                            </div>
                            {/* Result Counter */}
                            <div style={{ marginTop: '12px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                                Showing <strong>{filteredJobs.length}</strong> of {jobs.length} total jobs
                            </div>
                        </div>

                        {/* Area Filter */}
                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '12px' }}>üìç Filter by Area:</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                                <button className={`btn btn-sm ${selectedArea === 'all' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setSelectedArea('all')} >
                                    All Areas ({jobs.length})
                                </button>
                                {areas.map(area => (
                                    <button key={area} className={`btn btn-sm ${selectedArea === area ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setSelectedArea(area)} >
                                        {area} ({jobs.filter(j => j.area === area).length})
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Bulk Actions */}
                        {selectedJobs.length > 0 && (
                            <div className="bulk-actions-bar">
                                <div>
                                    <strong>{selectedJobs.length}</strong> selected
                                </div>
                                <button className="btn btn-danger btn-sm" onClick={bulkDeleteJobs}>
                                    üóëÔ∏è Delete Selected
                                </button>
                            </div>
                        )}

                        {/* Jobs Table */}
                        {filteredJobs.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th className="checkbox-cell">
                                            <input type="checkbox" className="checkbox-input" checked={selectedJobs.length === filteredJobs.length && filteredJobs.length > 0} onChange={toggleSelectAll} />
                                        </th>
                                        <th>Job #</th>
                                        <th>Client</th>
                                        <th>Location</th>
                                        <th>Area</th>
                                        <th>Status</th>
                                        <th>Truck</th>
                                        <th>Driver</th>
                                        <th>Value</th>
                                        <th>Start Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredJobs.map(job => (
                                        <tr key={job.id}>
                                            <td className="checkbox-cell">
                                                <input type="checkbox" className="checkbox-input" checked={selectedJobs.includes(job.id)} onChange={() => toggleJobSelection(job.id)} />
                                            </td>
                                            <td><strong>{job.jobNumber}</strong></td>
                                            <td>{job.clientName}</td>
                                            <td>{job.location}</td>
                                            <td><span className="area-tag" style={{ background: job.area === 'Unassigned' ? 'var(--secondary)' : 'var(--info)' }}>{job.area}</span></td>
                                            <td>
                                                <select
                                                    value={job.status}
                                                    onChange={(e) => updateJobStatus(job.id, e.target.value)}
                                                    className="form-select"
                                                    style={{ 
                                                        width: '130px', 
                                                        padding: '6px 10px', 
                                                        fontSize: '12px',
                                                        fontWeight: '600',
                                                        backgroundColor: 
                                                            job.status === 'completed' ? '#10b981' : 
                                                            job.status === 'active' ? '#06b6d4' : 
                                                            job.status === 'pending' ? '#f59e0b' : '#ef4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    <option value="pending">‚è≥ Pending</option>
                                                    <option value="active">üîÑ Active</option>
                                                    <option value="completed">‚úÖ Completed</option>
                                                    <option value="cancelled">‚ùå Cancelled</option>
                                                </select>
                                            </td>
                                            <td>{job.truck || '-'}</td>
                                            <td>{job.driver || '-'}</td>
                                            <td>¬£{(job.value || 0).toLocaleString()}</td>
                                            <td>{job.startDate ? new Date(job.startDate).toLocaleDateString('en-GB') : '-'}</td>
                                            <td>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('job', job)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteJob(job.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                                No jobs match your current filters.
                            </p>
                        )}
                    </div>
                </>
            );
        }

        // --- NEW/UPDATED VEHICLES VIEW ---
        function VehiclesView({ vehicles, openModal, loadData }) {
            const [searchText, setSearchText] = useState('');
            const [sortField, setSortField] = useState('registration');
            const [sortDirection, setSortDirection] = useState('asc');

            // NOTE: markActioned is kept for potential external calls (like from the dashboard)
            const markActioned = async (id, field) => {
                const vehicle = vehicles.find(v => v.id === id);
                if (!vehicle) return;

                try {
                    let updatedVehicle = { ...vehicle };

                    // Maintenance reset logic
                    if (field === 'maintenanceActioned' && vehicle.maintenanceDue) {
                        const currentDate = new Date(vehicle.maintenanceDue);
                        const nextDate = new Date(currentDate);
                        nextDate.setDate(nextDate.getDate() + 56); // 8 weeks

                        const nextDateStr = nextDate.toISOString().split('T')[0];
                        updatedVehicle.maintenanceDue = nextDateStr;
                        updatedVehicle.maintenanceActioned = false;

                        if (confirm(`Maintenance completed! Next maintenance will be due on ${nextDate.toLocaleDateString('en-GB')} (8 weeks from now). Continue?`)) {
                            await fetch(`${API_URL}/vehicles/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedVehicle)
                            });
                            loadData();
                            alert('‚úÖ Maintenance marked complete and next date set!');
                        }
                        return;
                    }

                    // For all other types, just mark actioned
                    updatedVehicle[field] = true;

                    await fetch(`${API_URL}/vehicles/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedVehicle)
                    });
                    loadData();
                } catch (error) {
                    alert('‚ùå Error updating vehicle');
                }
            };

            const deleteVehicle = async (id) => {
                if (!confirm('Are you sure you want to delete this vehicle?')) return;
                try {
                    await fetch(`${API_URL}/vehicles/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Vehicle deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting vehicle');
                }
            };

            const sortedVehicles = [...vehicles]
                .filter(veh => {
                    const searchLower = searchText.toLowerCase();
                    // üîç Search bar - search by registration, owner, insurance
                    return (
                        veh.registration.toLowerCase().includes(searchLower) ||
                        veh.ownerName.toLowerCase().includes(searchLower) ||
                        veh.insuranceName.toLowerCase().includes(searchLower)
                    );
                })
                .sort((a, b) => {
                    const valA = String(a[sortField]).toLowerCase();
                    const valB = String(b[sortField]).toLowerCase();

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

            // Component to render the date with color/days logic - UPDATED
            const VehicleDateCell = ({ dateStr, actioned, actionField }) => {
                const indicator = getDateIndicatorData(dateStr, actioned);

                if (indicator.status === 'N/A' || dateStr === null) {
                    return <span className="date-na">N/A</span>;
                }

                // Explicitly show 'Actioned' status
                if (indicator.status === 'Actioned') {
                    return (
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: 'var(--success)' }}>
                            <span className={`dot ${indicator.dotColor}`}></span>
                            {new Date(dateStr).toLocaleDateString('en-GB')}
                            <span style={{ fontSize: '11px', fontWeight: 600, padding: '2px 6px', background: 'rgba(16, 185, 129, 0.1)', borderRadius: '4px' }}>
                                Actioned
                            </span>
                        </div>
                    );
                }

                const daysLabel = indicator.daysUntil !== null ?
                    indicator.daysUntil < 0 ? `${Math.abs(indicator.daysUntil)} days overdue` :
                        indicator.daysUntil === 0 ? 'Today' :
                            `${indicator.daysUntil} days` : 'N/A';

                return (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div className={`date-indicator`} style={{ color: indicator.colorClass.replace('date-', '') }}>
                            <span className={`dot ${indicator.dotColor}`}></span>
                            {new Date(dateStr).toLocaleDateString('en-GB')}
                        </div>
                        {/* Days remaining shown next to each date */}
                        <span style={{ fontSize: '11px', fontWeight: 500, color: 'var(--text-secondary)' }}>
                            ({daysLabel})
                        </span>
                    </div>
                );
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Vehicles</h1>
                                <p style={{ color: 'var(--text-secondary)' }}>Track MOT, insurance, tax, tacho (30-day) and maintenance (1-week, 8-week cycle)</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('vehicle')}>
                                ‚ûï Add Vehicle
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üöó All Vehicles</h2>

                        {/* Vehicle Controls: Search and Sort */}
                        <div style={{ display: 'flex', gap: '24px', marginBottom: '24px', alignItems: 'center' }}>
                            <div style={{ flex: 1 }}>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="üîç Search by registration, owner, or insurance name..."
                                    value={searchText}
                                    onChange={(e) => setSearchText(e.target.value)}
                                />
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {/* Sort Options */}
                                <select
                                    className="form-select"
                                    value={sortField}
                                    onChange={(e) => setSortField(e.target.value)}
                                    style={{ width: 'auto' }}
                                >
                                    <option value="registration">üî¢ Sort by Registration</option>
                                    <option value="ownerName">Sort by Owner</option>
                                    <option value="vehicleType">Sort by Type</option>
                                </select>
                                <button className="btn btn-secondary btn-sm" onClick={() => setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')}>
                                    {sortDirection === 'asc' ? '‚¨ÜÔ∏è Asc' : '‚¨áÔ∏è Desc'}
                                </button>
                            </div>
                        </div>

                        {/* Color Guide */}
                        <div style={{ marginBottom: '24px', padding: '16px', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'var(--bg-primary)' }}>
                            <h3 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px' }}>üìñ Date Color Guide:</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '16px', fontSize: '13px' }}>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><div className="dot dot-green"></div> üü¢ Safe (&gt;30 days)</span>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><div className="dot dot-yellow"></div> üü° Warning (15-30 days)</span>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><div className="dot dot-orange"></div> üü† Orange (8-14 days)</span>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><div className="dot dot-red"></div> üî¥ Red (1-7 days/Today)</span>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><div className="dot dot-darkred"></div> ‚ö´ Dark Red (Overdue)</span>
                                <span style={{ display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--text-secondary)' }}>Actioned</span>
                            </div>
                        </div>


                        {sortedVehicles.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Registration</th>
                                        <th>Type</th>
                                        <th>Owner</th>
                                        <th>MOT Due</th>
                                        <th>Tax Due</th>
                                        <th>Insurance Due</th>
                                        {vehicles.some(v => v.vehicleType === 'truck') && <th>Tacho Due</th>}
                                        {vehicles.some(v => v.vehicleType === 'truck') && <th>Maintenance (8wk)</th>}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedVehicles.map(veh => (
                                        <tr key={veh.id}>
                                            <td><strong>{veh.registration}</strong></td>
                                            <td>{veh.vehicleType === 'truck' ? 'üöö Truck' : 'üöó ' + veh.vehicleType}</td>
                                            <td>{veh.ownerName}</td>
                                            <td>
                                                <VehicleDateCell dateStr={veh.motDue} actioned={veh.motActioned} actionField="motActioned" />
                                            </td>
                                            <td>
                                                <VehicleDateCell dateStr={veh.taxDue} actioned={veh.taxActioned} actionField="taxActioned" />
                                            </td>
                                            <td>
                                                <VehicleDateCell dateStr={veh.insuranceDue} actioned={veh.insuranceActioned} actionField="insuranceActioned" />
                                            </td>
                                            {vehicles.some(v => v.vehicleType === 'truck') && (
                                                <td>
                                                    {veh.vehicleType === 'truck' ? (
                                                        <VehicleDateCell dateStr={veh.tachoDue} actioned={veh.tachoActioned} actionField="tachoActioned" />
                                                    ) : 'N/A'}
                                                </td>
                                            )}
                                            {vehicles.some(v => v.vehicleType === 'truck') && (
                                                <td>
                                                    {veh.vehicleType === 'truck' ? (
                                                        <VehicleDateCell dateStr={veh.maintenanceDue} actioned={veh.maintenanceActioned} actionField="maintenanceActioned" />
                                                    ) : 'N/A'}
                                                </td>
                                            )}
                                            <td>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('vehicle', veh)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteVehicle(veh.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                                No vehicles added yet. Add your first vehicle!
                            </p>
                        )}
                    </div>
                </>
            );
        }
        // --- END NEW/UPDATED VEHICLES VIEW ---

        function SettingsView({ areas, setAreas, jobs, loadData }) {
            const [newAreaName, setNewAreaName] = useState('');
            const [editingArea, setEditingArea] = useState(null);
            const [editingName, setEditingName] = useState('');

            const addArea = () => {
                const trimmed = newAreaName.trim();
                if (!trimmed || areas.includes(trimmed)) {
                    alert('Invalid or duplicate area name');
                    return;
                }
                const newAreas = [...areas, trimmed].sort((a, b) => {
                    if (a === 'Unassigned') return 1;
                    if (b === 'Unassigned') return -1;
                    return a.localeCompare(b);
                });
                setAreas(newAreas);
                setNewAreaName('');
                alert(`‚úÖ Area "${trimmed}" added successfully`);
            };

            const startRename = (area) => {
                if (area === 'Unassigned') {
                    alert('Cannot rename "Unassigned" area');
                    return;
                }
                setEditingArea(area);
                setEditingName(area);
            };

            const saveRename = async () => {
                const trimmed = editingName.trim();
                if (!trimmed) {
                    alert('Please enter an area name');
                    return;
                }
                if (trimmed === editingArea) {
                    setEditingArea(null);
                    return;
                }
                if (areas.includes(trimmed)) {
                    alert('This area name already exists');
                    return;
                }

                // Update jobs with the old area name
                const jobsToUpdate = jobs.filter(j => j.area === editingArea);
                if (jobsToUpdate.length > 0) {
                    if (!confirm(`This will update ${jobsToUpdate.length} job(s) from "${editingArea}" to "${trimmed}". Continue?`)) {
                        setEditingArea(null);
                        return;
                    }
                    try {
                        // Update each job
                        for (const job of jobsToUpdate) {
                            await fetch(`${API_URL}/jobs/${job.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...job, area: trimmed })
                            });
                        }
                        await loadData();
                    } catch (error) {
                        alert('‚ùå Error updating jobs');
                        return;
                    }
                }

                // Update areas list
                const newAreas = areas.map(a => a === editingArea ? trimmed : a);
                setAreas(newAreas);
                setEditingArea(null);
                alert(`‚úÖ Area renamed from "${editingArea}" to "${trimmed}"`);
            };

            const deleteArea = (area) => {
                if (area === 'Unassigned') {
                    alert('Cannot delete "Unassigned" area');
                    return;
                }
                const jobCount = jobs.filter(j => j.area === area).length;
                if (jobCount > 0) {
                    if (!confirm(`This area has ${jobCount} job(s). These jobs will be moved to "Unassigned". Continue?`)) {
                        return;
                    }
                    // Move jobs to Unassigned
                    const jobsToUpdate = jobs.filter(j => j.area === area);
                    Promise.all(jobsToUpdate.map(job => fetch(`${API_URL}/jobs/${job.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...job, area: 'Unassigned' })
                    }))).then(() => {
                        // Then delete area and reload
                        const newAreas = areas.filter(a => a !== area);
                        setAreas(newAreas);
                        loadData();
                        alert(`‚úÖ Area "${area}" deleted. ${jobCount} jobs moved to "Unassigned".`);
                    }).catch(() => {
                        alert('‚ùå Error moving jobs/deleting area');
                    });
                } else {
                    if (!confirm(`Are you sure you want to delete the empty area "${area}"?`)) {
                        return;
                    }
                    const newAreas = areas.filter(a => a !== area);
                    setAreas(newAreas);
                    alert(`‚úÖ Area "${area}" deleted.`);
                }
            };

            return (
                <>
                    <div className="page-header">
                        <h1 style={{ fontSize: '32px', fontWeight: 700, marginBottom: '8px' }}>Settings</h1>
                        <p style={{ color: 'var(--text-secondary)' }}>Manage application settings and custom areas.</p>
                    </div>

                    <div className="section">
                        <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '24px' }}>üó∫Ô∏è Manage Areas</h2>

                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '12px' }}> Add New Area: </h3>
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                <input type="text" className="form-input" style={{ maxWidth: '300px' }} placeholder="Enter area name (e.g., Manchester)" value={newAreaName} onChange={(e) => setNewAreaName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addArea()} />
                                <button className="btn btn-primary" onClick={addArea}> ‚ûï Add Area </button>
                            </div>
                        </div>

                        <div>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '12px' }}> Existing Areas ({areas.length}) </h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Area Name</th>
                                        <th>Jobs Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {areas.map(area => (
                                        <tr key={area}>
                                            <td>
                                                {editingArea === area ? (
                                                    <input type="text" className="form-input" value={editingName} onChange={(e) => setEditingName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && saveRename()} autoFocus />
                                                ) : (
                                                    <strong>{area}</strong>
                                                )}
                                            </td>
                                            <td>
                                                <span className="info-badge">
                                                    {jobs.filter(j => j.area === area).length} jobs
                                                </span>
                                            </td>
                                            <td>
                                                {editingArea === area ? (
                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                        <button className="btn btn-sm btn-success" onClick={saveRename}> ‚úì Save </button>
                                                        <button className="btn btn-sm btn-secondary" onClick={() => setEditingArea(null)}> ‚úï Cancel </button>
                                                    </div>
                                                ) : (
                                                    <div style={{ display: 'flex', gap: '8px' }}>
                                                        <button className="btn btn-sm btn-secondary" onClick={() => startRename(area)} disabled={area === 'Unassigned'} >
                                                            ‚úèÔ∏è Rename
                                                        </button>
                                                        <button className="btn btn-sm btn-danger" onClick={() => deleteArea(area)} disabled={area === 'Unassigned'} >
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div style={{ marginTop: '24px', padding: '16px', background: 'var(--bg-primary)', borderRadius: '12px' }}>
                            <h4 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px' }}>Important Notes:</h4>
                            <ul style={{ listStyleType: 'disc', marginLeft: '20px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                                <li>The 'Unassigned' area is created automatically for jobs without a matching postcode prefix or manual assignment and cannot be renamed or deleted.</li>
                                <li>Renaming an area will automatically update that area for all existing jobs.</li>
                                <li>Deleting an area will move all its associated jobs to the 'Unassigned' area.</li>
                            </ul>
                        </div>
                    </div>
                </>
            );
        }

        function Modal({ type, item, closeModal, loadData, jobs, inquiries, invoices, vehicles, areas }) {
            const [invoiceItems, setInvoiceItems] = useState(item?.items ? JSON.parse(item.items) : [{ description: '', quantity: 1, rate: 0 }]);
            const addInvoiceItem = () => {
                setInvoiceItems([...invoiceItems, { description: '', quantity: 1, rate: 0 }]);
            };
            const removeInvoiceItem = (index) => {
                setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
            };
            const [vehicleType, setVehicleType] = useState(item?.vehicleType || 'car'); // Default vehicle type to car if not provided
            const [truckTacho, setTruckTacho] = useState(item?.tachoDue || '');
            const [truckMaintenance, setTruckMaintenance] = useState(item?.maintenanceDue || '');

            // --- NEW FUNCTION: Reset Actioned Status ---
            const resetActioned = async (field) => {
                if (!item || !item.id) return;
                
                if (!confirm(`Are you sure you want to UN-ACTION the status for this item? The reminder will become active again.`)) {
                    return;
                }

                try {
                    const updatedVehicle = { ...item, [field]: false };
                    
                    const response = await fetch(`${API_URL}/vehicles/${item.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedVehicle)
                    });

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.statusText}`);
                    }
                    
                    // Close the modal and reload the data to refresh the views
                    closeModal();
                    loadData();
                    alert(`‚úÖ Status reset successfully. Reminder is now active.`);

                } catch (error) {
                    alert(`‚ùå Error resetting status: ${error.message}`);
                }
            };
            // --- END NEW FUNCTION ---


            const handleSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                let payload = {};

                if (type === 'invoice') {
                    const items = [];
                    const itemCount = formData.getAll('item-description').length;
                    for (let i = 0; i < itemCount; i++) {
                        items.push({
                            description: formData.getAll('item-description')[i],
                            quantity: parseFloat(formData.getAll('item-quantity')[i]),
                            rate: parseFloat(formData.getAll('item-rate')[i])
                        });
                    }
                    const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                    const vatCheckbox = document.getElementById('vatAppliedCheckbox');
                    const vatApplied = vatCheckbox ? vatCheckbox.checked : true;
                    const vat = vatApplied ? subtotal * 0.20 : 0;

                    payload = {
                        invoiceNumber: formData.get('invoiceNumber'),
                        clientName: formData.get('clientName'),
                        clientAddress: formData.get('clientAddress'),
                        clientPhone: formData.get('clientPhone'),
                        date: formData.get('date'),
                        status: item?.status || 'pending',
                        items: JSON.stringify(items),
                        subtotal: subtotal,
                        vat: vat,
                        vatApplied: vatApplied,
                        total: subtotal + vat,
                        notes: formData.get('notes')
                    };
                } else if (type === 'inquiry') {
                    const name = formData.get('name');
                    const phone = formData.get('phone');
                    const location = formData.get('location');
                    const status = formData.get('status');
                    const date = formData.get('date');
                    
                    if (!name || !phone || !location || !status || !date) {
                        alert('‚ùå Name, Phone, Location, Status, and Date are required fields!');
                        return;
                    }
                    
                    payload = {
                        name: name,
                        phone: phone,
                        email: formData.get('email') || '',
                        location: location,
                        status: status,
                        date: date,
                        quoteAmount: parseFloat(formData.get('quoteAmount')) || null,
                        notes: formData.get('notes')
                    };
                } else if (type === 'job') {
                    const selectedArea = formData.get('area');
                    payload = {
                        jobNumber: formData.get('jobNumber'),
                        clientName: formData.get('clientName'),
                        location: formData.get('location'),
                        area: areas.includes(selectedArea) ? selectedArea : 'Unassigned',
                        jobType: formData.get('jobType'),
                        truck: formData.get('truck'),
                        driver: formData.get('driver'),
                        startDate: formData.get('startDate'),
                        endDate: formData.get('endDate'),
                        status: formData.get('status'),
                        value: parseFloat(formData.get('value')) || null,
                        notes: formData.get('notes')
                    };
                } else if (type === 'vehicle') {
                    const vehicleType = formData.get('vehicleType');
                    payload = {
                        registration: formData.get('registration').toUpperCase(),
                        vehicleType: vehicleType,
                        ownerName: formData.get('ownerName'),
                        insuranceName: formData.get('insuranceName'),
                        motDue: formData.get('motDue') || null,
                        taxDue: formData.get('taxDue'),
                        tachoDue: vehicleType === 'truck' ? formData.get('tachoDue') : null,
                        maintenanceDue: vehicleType === 'truck' ? formData.get('maintenanceDue') : null,
                        insuranceDue: formData.get('insuranceDue'),
                        // Retain original actioned status unless reset is explicitly performed
                        motActioned: item?.motActioned || false,
                        taxActioned: item?.taxActioned || false,
                        tachoActioned: item?.tachoActioned || false,
                        insuranceActioned: item?.insuranceActioned || false,
                        maintenanceActioned: item?.maintenanceActioned || false
                    };
                }

                try {
                    // Fix pluralization for inquiry -> inquiries
                    const pluralType = type === 'inquiry' ? 'inquiries' : `${type}s`;
                    const endpoint = item ? `${API_URL}/${pluralType}/${item.id}` : `${API_URL}/${pluralType}`;
                    const method = item ? 'PUT' : 'POST';

                    const response = await fetch(endpoint, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.statusText}`);
                    }

                    closeModal();
                    loadData();
                    alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} saved successfully!`);
                } catch (error) {
                    alert(`‚ùå Error saving ${type}: ${error.message}`);
                }
            };

            // Get truck vehicles for dropdown
            const truckVehicles = vehicles?.filter(v => v.vehicleType === 'truck') || [];

            return (
                <div className="modal-overlay" onClick={closeModal}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>
                                {item ? 'Edit' : 'New'} {type.charAt(0).toUpperCase() + type.slice(1)}
                            </h2>
                            <button onClick={closeModal} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' }}>‚úï</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                {type === 'invoice' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Invoice Number *</label>
                                            <input type="text" name="invoiceNumber" className="form-input" defaultValue={item?.invoiceNumber || `INV-${Date.now()}`} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Name *</label>
                                            <input type="text" name="clientName" className="form-input" defaultValue={item?.clientName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Address</label>
                                            <input type="text" name="clientAddress" className="form-input" defaultValue={item?.clientAddress} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Phone</label>
                                            <input type="text" name="clientPhone" className="form-input" defaultValue={item?.clientPhone} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Date *</label>
                                            <input type="date" name="date" className="form-input" defaultValue={item?.date || new Date().toISOString().split('T')[0]} required />                                        </div>
                                        <div className="form-group">
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <input 
                                                    type="checkbox" 
                                                    name="vatApplied" 
                                                    id="vatAppliedCheckbox"
                                                    defaultChecked={item?.vatApplied !== false}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                                <label htmlFor="vatAppliedCheckbox" style={{ marginBottom: 0, cursor: 'pointer', fontSize: '14px', fontWeight: '600' }}>
                                                    Apply VAT (20%)
                                                </label>
                                            </div>
                                            <small style={{ color: 'var(--text-secondary)', fontSize: '11px', display: 'block', marginTop: '4px' }}>
                                                ‚úì Checked = Include VAT | ‚úó Unchecked = No VAT (exempt)
                                            </small>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Items</label>
                                            {invoiceItems.map((item, index) => (
                                                <div key={index} style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                                                    <input type="text" name="item-description" className="form-input" placeholder="Description" defaultValue={item.description} required />
                                                    <input type="number" name="item-quantity" className="form-input" placeholder="Qty" defaultValue={item.quantity} style={{ width: '80px' }} required />
                                                    <input type="number" name="item-rate" className="form-input" placeholder="Rate" defaultValue={item.rate} style={{ width: '100px' }} step="0.01" required />
                                                    {invoiceItems.length > 1 && (
                                                        <button type="button" className="btn btn-danger btn-sm" onClick={() => removeInvoiceItem(index)}>üóëÔ∏è</button>
                                                    )}
                                                </div>
                                            ))}
                                            <button type="button" className="btn btn-secondary btn-sm" onClick={addInvoiceItem}>+ Add Item</button>
                                        </div>
                                        {item && (
                                            <div className="form-group">
                                                <button type="button" className="btn btn-secondary" 
                                                    onClick={() => {
                                                        window.open(`http://127.0.0.1:5000/api/invoices/${item.id}/preview`, '_blank');
                                                    }}>
                                                    üìä Export to Excel
                                                </button>
                                            </div>
                                        )}
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}
                                {type === 'inquiry' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Client Name *</label>
                                            <input type="text" name="name" className="form-input" defaultValue={item?.name} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Phone *</label>
                                            <input type="text" name="phone" className="form-input" defaultValue={item?.phone} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Email</label>
                                            <input type="email" name="email" className="form-input" defaultValue={item?.email} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Location/Address *</label>
                                            <input type="text" name="location" className="form-input" defaultValue={item?.location} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Date *</label>
                                            <input type="date" name="date" className="form-input" defaultValue={item?.date || new Date().toISOString().split('T')[0]} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Status *</label>
                                            <select name="status" className="form-select" defaultValue={item?.status || 'new'} required>
                                                <option value="new">New</option>
                                                <option value="contacted">Contacted</option>
                                                <option value="quoted">Quoted</option>
                                                <option value="closed">Closed/Lost</option>
                                                <option value="converted">Converted to Job</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Quote Amount (if quoted)</label>
                                            <input type="number" name="quoteAmount" className="form-input" defaultValue={item?.quoteAmount} step="0.01" />
                                        </div>
                                        <div className="form-group">
                                            <div className="checkbox-group">
                                                <input type="checkbox" name="vatApplied" id="vatApplied" 
                                                    defaultChecked={item?.vatApplied !== false} />
                                                <label htmlFor="vatApplied" style={{marginLeft: '8px'}}>
                                                    Apply VAT (20%)
                                                </label>
                                            </div>
                                        </div>
                                        {item && (
                                            <div className="form-group">
                                                <button type="button" className="btn btn-secondary" 
                                                    onClick={() => {
                                                        window.open(`http://127.0.0.1:5000/api/invoices/${item.id}/preview`, '_blank');
                                                    }}>
                                                    üìä Export to Excel
                                                </button>
                                            </div>
                                        )}
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}
                                {type === 'job' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Job Number *</label>
                                            <input type="text" name="jobNumber" className="form-input" defaultValue={item?.jobNumber || `JOB-${Date.now()}`} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Name *</label>
                                            <input type="text" name="clientName" className="form-input" defaultValue={item?.clientName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Location *</label>
                                            <input type="text" name="location" className="form-input" defaultValue={item?.location} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Area *</label>
                                            <select name="area" className="form-select" defaultValue={item?.area || 'Unassigned'} required>
                                                {areas.map(area => (
                                                    <option key={area} value={area}>{area}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Job Type</label>
                                            <input type="text" name="jobType" className="form-input" defaultValue={item?.jobType} placeholder="e.g., Residential, Commercial" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">üöö Truck / Vehicle</label>
                                            {truckVehicles.length > 0 ? (
                                                <select name="truck" className="form-select" defaultValue={item?.truck || ''}>
                                                    <option value="">-- Select Truck --</option>
                                                    {truckVehicles.map(truck => (
                                                        <option key={truck.id} value={truck.registration}>
                                                            üöö {truck.registration} - {truck.ownerName}
                                                        </option>
                                                    ))}
                                                </select>
                                            ) : (
                                                <>
                                                    <input type="text" name="truck" className="form-input" defaultValue={item?.truck} placeholder="e.g., Registration or truck name" />
                                                    <small style={{ color: 'var(--warning)', fontSize: '12px', marginTop: '4px', display: 'block' }}>
                                                        ‚ÑπÔ∏è Add a vehicle of type 'Truck' in the Vehicles tab to enable dropdown selection.
                                                    </small>
                                                </>
                                            )}
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">üßë Driver</label>
                                            <input type="text" name="driver" className="form-input" defaultValue={item?.driver} placeholder="e.g., John Smith" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Start Date *</label>
                                            <input type="date" name="startDate" className="form-input" defaultValue={item?.startDate || new Date().toISOString().split('T')[0]} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Finish Date</label>
                                            <input type="date" name="endDate" className="form-input" defaultValue={item?.endDate} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Status *</label>
                                            <select name="status" className="form-select" defaultValue={item?.status || 'pending'} required>
                                                <option value="pending">Pending</option>
                                                <option value="active">Active</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Value (¬£)</label>
                                            <input type="number" name="value" className="form-input" defaultValue={item?.value} step="0.01" />
                                        </div>
                                        {item && (
                                            <div className="form-group">
                                                <button type="button" className="btn btn-secondary" 
                                                    onClick={() => {
                                                        window.open(`http://127.0.0.1:5000/api/invoices/${item.id}/preview`, '_blank');
                                                    }}>
                                                    üìä Export to Excel
                                                </button>
                                            </div>
                                        )}
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}
                                {type === 'vehicle' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Registration *</label>
                                            <input type="text" name="registration" className="form-input" defaultValue={item?.registration} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Vehicle Type *</label>
                                            <select name="vehicleType" className="form-select" value={vehicleType} onChange={(e) => setVehicleType(e.target.value)} required>
                                                <option value="car">Car/Van</option>
                                                <option value="truck">Truck</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Owner Name</label>
                                            <input type="text" name="ownerName" className="form-input" defaultValue={item?.ownerName} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Insurance Company</label>
                                            <input type="text" name="insuranceName" className="form-input" defaultValue={item?.insuranceName} />
                                        </div>

                                        {/* MOT Due Date Field */}
                                        <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                                            <div style={{ flex: 1 }}>
                                                <label className="form-label">MOT Due *</label>
                                                <input type="date" name="motDue" className="form-input" defaultValue={item?.motDue} />
                                            </div>
                                            {item?.motActioned && (
                                                <button type="button" className="btn btn-sm btn-danger" onClick={() => resetActioned('motActioned')} style={{ marginBottom: '1px' }}>
                                                    ‚ùå Reset Status
                                                </button>
                                            )}
                                        </div>

                                        {/* Tax Due Date Field */}
                                        <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                                            <div style={{ flex: 1 }}>
                                                <label className="form-label">Tax Due (14-day advance) *</label>
                                                <input type="date" name="taxDue" className="form-input" defaultValue={item?.taxDue} required />
                                            </div>
                                            {item?.taxActioned && (
                                                <button type="button" className="btn btn-sm btn-danger" onClick={() => resetActioned('taxActioned')} style={{ marginBottom: '1px' }}>
                                                    ‚ùå Reset Status
                                                </button>
                                            )}
                                        </div>

                                        {/* Insurance Due Date Field */}
                                        <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                                            <div style={{ flex: 1 }}>
                                                <label className="form-label">Insurance Due (60-day advance) *</label>
                                                <input type="date" name="insuranceDue" className="form-input" defaultValue={item?.insuranceDue} required />
                                            </div>
                                            {item?.insuranceActioned && (
                                                <button type="button" className="btn btn-sm btn-danger" onClick={() => resetActioned('insuranceActioned')} style={{ marginBottom: '1px' }}>
                                                    ‚ùå Reset Status
                                                </button>
                                            )}
                                        </div>

                                        {vehicleType === 'truck' && (
                                            <>
                                                {/* Tacho Due Date Field */}
                                                <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <label className="form-label">Tacho Due (30-day advance)</label>
                                                        <input type="date" name="tachoDue" className="form-input" defaultValue={item?.tachoDue} />
                                                    </div>
                                                    {item?.tachoActioned && (
                                                        <button type="button" className="btn btn-sm btn-danger" onClick={() => resetActioned('tachoActioned')} style={{ marginBottom: '1px' }}>
                                                            ‚ùå Reset Status
                                                        </button>
                                                    )}
                                                </div>

                                                {/* Maintenance Due Date Field */}
                                                <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <label className="form-label">Maintenance Due (8-week cycle)</label>
                                                        <input type="date" name="maintenanceDue" className="form-input" defaultValue={item?.maintenanceDue} />
                                                        <small style={{ color: 'var(--info)', fontSize: '12px', marginTop: '4px', display: 'block' }}>
                                                            ‚ÑπÔ∏è When marked "Done", automatically sets next date 8 weeks ahead
                                                        </small>
                                                    </div>
                                                    {/* NOTE: Maintenance status is NOT reset here as the dashboard 'Done' automatically sets the next date and resets the status */}
                                                    {item?.maintenanceActioned && (
                                                        <span style={{ color: 'var(--success)', fontSize: '12px', fontWeight: 600, padding: '10px 0', marginBottom: '1px' }}>
                                                            Actioned (Next date needed)
                                                        </span>
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </>
                                )}
                            </div>
                            <div style={{ padding: '24px', borderTop: '1px solid var(--border)', display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                <button type="button" className="btn btn-secondary" onClick={closeModal}>Cancel</button>
                                <button type="submit" className="btn btn-primary">Save {type.charAt(0).toUpperCase() + type.slice(1)}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }



        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>