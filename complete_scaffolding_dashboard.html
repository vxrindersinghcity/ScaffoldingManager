<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khalsa Scaffolding - Business Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-primary);
            color: var(--primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .nav-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
        }

        .page-header {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .date-time-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }

        .link-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-badge:hover {
            background: var(--primary-dark);
        }

        .area-tag {
            display: inline-block;
            padding: 4px 12px;
            background: var(--info);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 12px;
            border-left: 4px solid var(--warning);
            margin-bottom: 12px;
        }

        .reminder-item.urgent {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, var(--bg-primary) 100%);
        }

        .reminder-item.overdue {
            border-left-color: #dc2626;
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.1) 0%, var(--bg-primary) 100%);
        }

        .info-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .checkbox-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .bulk-actions-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://127.0.0.1:5000/api';

        // Load areas from localStorage or use defaults
        const loadAreas = () => {
            const saved = localStorage.getItem('scaffolding_areas');
            return saved ? JSON.parse(saved) : ['Peterborough', 'Leicester', 'London', 'Birmingham', 'Unassigned'];
        };

        const saveAreas = (areas) => {
            localStorage.setItem('scaffolding_areas', JSON.stringify(areas));
        };

        function App() {
            const [activeView, setActiveView] = useState('dashboard');
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [currentDateTime, setCurrentDateTime] = useState(new Date());
            const [areas, setAreas] = useState(loadAreas());

            const [invoices, setInvoices] = useState([]);
            const [inquiries, setInquiries] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [jobs, setJobs] = useState([]);

            useEffect(() => {
                loadData();
                const timer = setInterval(() => {
                    setCurrentDateTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Save areas whenever they change
            useEffect(() => {
                saveAreas(areas);
            }, [areas]);

            const loadData = async () => {
                try {
                    const [invRes, inqRes, vehRes, jobRes] = await Promise.all([
                        fetch(`${API_URL}/invoices`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/inquiries`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/vehicles`).catch(() => ({ json: async () => [] })),
                        fetch(`${API_URL}/jobs`).catch(() => ({ json: async () => [] }))
                    ]);
                    setInvoices(await invRes.json());
                    setInquiries(await inqRes.json());
                    setVehicles(await vehRes.json());
                    const jobsData = await jobRes.json();
                    const processedJobs = jobsData.map(job => ({
                        ...job,
                        area: (job.area && areas.includes(job.area)) ? job.area : 'Unassigned'
                    }));
                    setJobs(processedJobs);
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const openModal = (type, item = null) => {
                setModalType(type);
                setEditingItem(item);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setModalType('');
                setEditingItem(null);
            };

            function getVehicleReminders(vehicles) {
                const today = new Date();
                const reminders = [];

                vehicles.forEach(vehicle => {
                    const checkDate = (dateStr, type, advanceDays, actioned) => {
                        if (!dateStr || actioned) return;
                        
                        const dueDate = new Date(dateStr);
                        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= advanceDays) {
                            const vehicleLabel = vehicle.vehicleType === 'truck' ? 'üöö' : 'üöó';
                            reminders.push({
                                vehicleId: vehicle.id,
                                vehicle: `${vehicleLabel} ${vehicle.registration}`,
                                owner: vehicle.ownerName,
                                type: type,
                                dueDate: dateStr,
                                daysUntil: daysUntil,
                                isOverdue: daysUntil < 0,
                                isUrgent: daysUntil <= 7 && daysUntil >= 0,
                                actionField: type === 'MOT' ? 'motActioned' : 
                                           type === 'Tax' ? 'taxActioned' : 
                                           type === 'Tacho' ? 'tachoActioned' :
                                           type === 'Maintenance' ? 'maintenanceActioned' :
                                           'insuranceActioned',
                                needsReset: type === 'Maintenance'
                            });
                        }
                    };

                    checkDate(vehicle.motDue, 'MOT', 30, vehicle.motActioned);
                    checkDate(vehicle.taxDue, 'Tax', 14, vehicle.taxActioned);
                    checkDate(vehicle.insuranceDue, 'Insurance', 60, vehicle.insuranceActioned);
                    
                    if (vehicle.vehicleType === 'truck') {
                        checkDate(vehicle.tachoDue, 'Tacho', 30, vehicle.tachoActioned);
                        checkDate(vehicle.maintenanceDue, 'Maintenance', 7, vehicle.maintenanceActioned);
                    }
                });

                return reminders.sort((a, b) => a.daysUntil - b.daysUntil);
            }

            const stats = {
                totalRevenue: invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (inv.total || 0), 0),
                pendingInvoices: invoices.filter(inv => inv.status === 'pending').length,
                activeJobs: jobs.filter(job => job.status === 'active').length,
                newInquiries: inquiries.filter(inq => inq.status === 'new').length,
                vehicleReminders: getVehicleReminders(vehicles).length
            };

            const formatDateTime = (date) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                let hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                
                return `${dayName}, ${day} ${month} ${year} ‚Ä¢ ${hours}:${minutes}:${seconds} ${ampm}`;
            };

            return (
                <div className="app-container">
                    <Sidebar 
                        activeView={activeView} 
                        setActiveView={setActiveView}
                        stats={stats}
                    />
                    <main className="main-content">
                        {activeView === 'dashboard' && (
                            <Dashboard 
                                stats={stats} 
                                invoices={invoices}
                                vehicles={vehicles}
                                openModal={openModal}
                                setActiveView={setActiveView}
                                loadData={loadData}
                                currentDateTime={currentDateTime}
                                formatDateTime={formatDateTime}
                                getVehicleReminders={getVehicleReminders}
                            />
                        )}
                        {activeView === 'invoices' && (
                            <InvoicesView 
                                invoices={invoices}
                                jobs={jobs}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'inquiries' && (
                            <InquiriesView 
                                inquiries={inquiries}
                                jobs={jobs}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'jobs' && (
                            <JobsView 
                                jobs={jobs}
                                invoices={invoices}
                                inquiries={inquiries}
                                vehicles={vehicles}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'vehicles' && (
                            <VehiclesView 
                                vehicles={vehicles}
                                openModal={openModal}
                                loadData={loadData}
                            />
                        )}
                        {activeView === 'settings' && (
                            <SettingsView 
                                areas={areas}
                                setAreas={setAreas}
                                jobs={jobs}
                                loadData={loadData}
                            />
                        )}
                    </main>

                    {showModal && (
                        <Modal
                            type={modalType}
                            item={editingItem}
                            closeModal={closeModal}
                            loadData={loadData}
                            jobs={jobs}
                            inquiries={inquiries}
                            invoices={invoices}
                            vehicles={vehicles}
                            areas={areas}
                        />
                    )}
                </div>
            );
        }

        function Sidebar({ activeView, setActiveView, stats }) {
            return (
                <aside className="sidebar">
                    <div className="sidebar-header">
                        <div className="logo">
                            <div className="logo-icon">üèóÔ∏è</div>
                            <div>
                                <h1 style={{fontSize: '18px', fontWeight: 700}}>Khalsa Scaffolding</h1>
                                <p style={{fontSize: '12px', opacity: 0.9}}>Business Manager</p>
                            </div>
                        </div>
                    </div>
                    
                    <nav className="sidebar-nav">
                        <div className={`nav-item ${activeView === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveView('dashboard')}>
                            <span>üìä</span>
                            <span>Dashboard</span>
                        </div>
                        <div className={`nav-item ${activeView === 'invoices' ? 'active' : ''}`} onClick={() => setActiveView('invoices')}>
                            <span>üìÑ</span>
                            <span>Invoices</span>
                        </div>
                        <div className={`nav-item ${activeView === 'inquiries' ? 'active' : ''}`} onClick={() => setActiveView('inquiries')}>
                            <span>üí¨</span>
                            <span>Inquiries</span>
                            {stats.newInquiries > 0 && <span className="nav-badge">{stats.newInquiries}</span>}
                        </div>
                        <div className={`nav-item ${activeView === 'jobs' ? 'active' : ''}`} onClick={() => setActiveView('jobs')}>
                            <span>üî®</span>
                            <span>Jobs</span>
                        </div>
                        <div className={`nav-item ${activeView === 'vehicles' ? 'active' : ''}`} onClick={() => setActiveView('vehicles')}>
                            <span>üöó</span>
                            <span>Vehicles</span>
                            {stats.vehicleReminders > 0 && <span className="nav-badge">{stats.vehicleReminders}</span>}
                        </div>
                        <div className={`nav-item ${activeView === 'settings' ? 'active' : ''}`} onClick={() => setActiveView('settings')}>
                            <span>‚öôÔ∏è</span>
                            <span>Settings</span>
                        </div>
                    </nav>
                </aside>
            );
        }

        function Dashboard({ stats, invoices, vehicles, openModal, setActiveView, loadData, currentDateTime, formatDateTime, getVehicleReminders }) {
            const reminders = getVehicleReminders(vehicles);

            const markVehicleActioned = async (reminder) => {
                const vehicle = vehicles.find(v => v.id === reminder.vehicleId);
                if (!vehicle) return;
                
                try {
                    let updatedVehicle = { ...vehicle, [reminder.actionField]: true };
                    
                    if (reminder.needsReset && reminder.type === 'Maintenance') {
                        const currentDate = new Date(reminder.dueDate);
                        const nextDate = new Date(currentDate);
                        nextDate.setDate(nextDate.getDate() + 56);
                        
                        const nextDateStr = nextDate.toISOString().split('T')[0];
                        updatedVehicle.maintenanceDue = nextDateStr;
                        updatedVehicle.maintenanceActioned = false;
                        
                        if (confirm(`Maintenance completed! Next maintenance will be due on ${nextDate.toLocaleDateString('en-GB')} (8 weeks from now). Continue?`)) {
                            await fetch(`${API_URL}/vehicles/${reminder.vehicleId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedVehicle)
                            });
                            loadData();
                            alert('‚úÖ Maintenance marked complete and next date set!');
                        }
                    } else {
                        await fetch(`${API_URL}/vehicles/${reminder.vehicleId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updatedVehicle)
                        });
                        loadData();
                    }
                } catch (error) {
                    alert('‚ùå Error updating vehicle');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                            <div>
                                <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Dashboard</h1>
                                <p style={{color: 'var(--text-secondary)'}}>Welcome back! Here's what's happening with your business.</p>
                            </div>
                        </div>
                        <div className="date-time-display">
                            <span>üïê</span>
                            <span>{formatDateTime(currentDateTime)}</span>
                        </div>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                <div>
                                    <div style={{fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px'}}>TOTAL REVENUE</div>
                                    <div style={{fontSize: '36px', fontWeight: 700}}>¬£{stats.totalRevenue.toLocaleString()}</div>
                                </div>
                                <div style={{fontSize: '48px'}}>üí∞</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{'--primary': 'var(--warning)'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                <div>
                                    <div style={{fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px'}}>PENDING INVOICES</div>
                                    <div style={{fontSize: '36px', fontWeight: 700}}>{stats.pendingInvoices}</div>
                                </div>
                                <div style={{fontSize: '48px'}}>‚è≥</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{'--primary': 'var(--success)'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                <div>
                                    <div style={{fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px'}}>ACTIVE JOBS</div>
                                    <div style={{fontSize: '36px', fontWeight: 700}}>{stats.activeJobs}</div>
                                </div>
                                <div style={{fontSize: '48px'}}>üî®</div>
                            </div>
                        </div>

                        <div className="stat-card" style={{'--primary': 'var(--danger)'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                <div>
                                    <div style={{fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '8px'}}>NEW INQUIRIES</div>
                                    <div style={{fontSize: '36px', fontWeight: 700}}>{stats.newInquiries}</div>
                                </div>
                                <div style={{fontSize: '48px'}}>üí¨</div>
                            </div>
                        </div>
                    </div>

                    {reminders.length > 0 && (
                        <div className="section">
                            <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>üö® Vehicle Reminders</h2>
                            <div>
                                {reminders.map((reminder, idx) => (
                                    <div key={idx} className={`reminder-item ${reminder.isOverdue ? 'overdue' : reminder.isUrgent ? 'urgent' : ''}`}>
                                        <div style={{flex: 1}}>
                                            <div style={{fontWeight: 600, marginBottom: '4px'}}>
                                                {reminder.vehicle} - {reminder.type} Due
                                                {reminder.type === 'Maintenance' && ' (8-week cycle)'}
                                            </div>
                                            <div style={{fontSize: '13px', color: 'var(--text-secondary)'}}>
                                                Owner: {reminder.owner} ‚Ä¢ Due: {new Date(reminder.dueDate).toLocaleDateString('en-GB')}
                                            </div>
                                        </div>
                                        <div style={{
                                            padding: '6px 12px',
                                            background: 'white',
                                            borderRadius: '6px',
                                            fontWeight: 600,
                                            color: reminder.isOverdue ? '#dc2626' : reminder.isUrgent ? 'var(--danger)' : 'var(--warning)'
                                        }}>
                                            {reminder.isOverdue ? `${Math.abs(reminder.daysUntil)} days overdue` : 
                                             reminder.daysUntil === 0 ? 'Today' : 
                                             reminder.daysUntil === 1 ? 'Tomorrow' : 
                                             `${reminder.daysUntil} days`}
                                        </div>
                                        <button 
                                            className="btn btn-success btn-sm"
                                            onClick={() => markVehicleActioned(reminder)}
                                        >
                                            ‚úì Done
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="section">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px'}}>
                            <h2 style={{fontSize: '20px', fontWeight: 700}}>üìã Recent Invoices</h2>
                            <button className="btn btn-secondary btn-sm" onClick={() => setActiveView('invoices')}>
                                View All ‚Üí
                            </button>
                        </div>
                        {invoices.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {invoices.slice(0, 5).map(inv => (
                                        <tr key={inv.id}>
                                            <td><strong>{inv.invoiceNumber}</strong></td>
                                            <td>{inv.clientName}</td>
                                            <td>{new Date(inv.date).toLocaleDateString('en-GB')}</td>
                                            <td><strong>¬£{(inv.total || 0).toLocaleString()}</strong></td>
                                            <td>
                                                <span className={`badge badge-${inv.status === 'paid' ? 'success' : 'warning'}`}>
                                                    {inv.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{textAlign: 'center', padding: '40px', color: 'var(--text-secondary)'}}>
                                No invoices yet. Create your first invoice to get started!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function InvoicesView({ invoices, jobs, openModal, loadData }) {
            const deleteInvoice = async (id) => {
                if (!confirm('Are you sure you want to delete this invoice?')) return;
                try {
                    await fetch(`${API_URL}/invoices/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Invoice deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting invoice');
                }
            };

            const updateStatus = async (id, newStatus) => {
                const invoice = invoices.find(inv => inv.id === id);
                if (!invoice) return;
                try {
                    await fetch(`${API_URL}/invoices/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...invoice, status: newStatus })
                    });
                    loadData();
                } catch (error) {
                    alert('‚ùå Error updating status');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Invoices</h1>
                                <p style={{color: 'var(--text-secondary)'}}>Manage all your invoices and billing</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('invoice')}>
                                ‚ûï New Invoice
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>üìÑ All Invoices</h2>
                        {invoices.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Linked Job</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {invoices.map(inv => (
                                        <tr key={inv.id}>
                                            <td><strong>{inv.invoiceNumber}</strong></td>
                                            <td>{inv.clientName}</td>
                                            <td>{new Date(inv.date).toLocaleDateString('en-GB')}</td>
                                            <td><strong>¬£{(inv.total || 0).toLocaleString()}</strong></td>
                                            <td>
                                                <select 
                                                    value={inv.status}
                                                    onChange={(e) => updateStatus(inv.id, e.target.value)}
                                                    className="form-select"
                                                    style={{width: 'auto', padding: '4px 8px', fontSize: '12px'}}
                                                >
                                                    <option value="pending">Pending</option>
                                                    <option value="paid">Paid</option>
                                                    <option value="overdue">Overdue</option>
                                                </select>
                                            </td>
                                            <td>
                                                {inv.linkedJobId ? (
                                                    <span className="link-badge">
                                                        üîó Job #{inv.linkedJobId}
                                                    </span>
                                                ) : (
                                                    <span style={{fontSize: '12px', color: 'var(--text-secondary)'}}>-</span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('invoice', inv)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteInvoice(inv.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{textAlign: 'center', padding: '40px', color: 'var(--text-secondary)'}}>
                                No invoices yet. Create your first invoice!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function InquiriesView({ inquiries, jobs, openModal, loadData }) {
            const deleteInquiry = async (id) => {
                if (!confirm('Are you sure you want to delete this inquiry?')) return;
                try {
                    await fetch(`${API_URL}/inquiries/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Inquiry deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting inquiry');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Inquiries</h1>
                                <p style={{color: 'var(--text-secondary)'}}>Track and manage customer inquiries</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('inquiry')}>
                                ‚ûï New Inquiry
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>üí¨ All Inquiries</h2>
                        {inquiries.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Location</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Linked Job</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {inquiries.map(inq => (
                                        <tr key={inq.id}>
                                            <td><strong>{inq.name}</strong></td>
                                            <td>{inq.phone}</td>
                                            <td>{inq.location}</td>
                                            <td>{new Date(inq.date).toLocaleDateString('en-GB')}</td>
                                            <td>
                                                <span className={`badge badge-${
                                                    inq.status === 'new' ? 'danger' : 
                                                    inq.status === 'contacted' ? 'warning' : 
                                                    inq.status === 'quoted' ? 'info' : 'success'
                                                }`}>
                                                    {inq.status}
                                                </span>
                                            </td>
                                            <td>
                                                {inq.linkedJobId ? (
                                                    <span className="link-badge">
                                                        üîó Job #{inq.linkedJobId}
                                                    </span>
                                                ) : (
                                                    <span style={{fontSize: '12px', color: 'var(--text-secondary)'}}>-</span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('inquiry', inq)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteInquiry(inq.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{textAlign: 'center', padding: '40px', color: 'var(--text-secondary)'}}>
                                No inquiries yet. Add your first inquiry!
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function JobsView({ jobs, invoices, inquiries, vehicles, openModal, loadData }) {
            const [selectedArea, setSelectedArea] = useState('all');
            const [selectedJobs, setSelectedJobs] = useState([]);

            // Get areas from parent
            const areas = loadAreas();

            const filteredJobs = selectedArea === 'all' ? jobs : jobs.filter(job => job.area === selectedArea);

            const deleteJob = async (id) => {
                if (!confirm('Are you sure you want to delete this job?')) return;
                try {
                    await fetch(`${API_URL}/jobs/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Job deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting job');
                }
            };

            const toggleJobSelection = (jobId) => {
                setSelectedJobs(prev => 
                    prev.includes(jobId) 
                        ? prev.filter(id => id !== jobId)
                        : [...prev, jobId]
                );
            };

            const toggleSelectAll = () => {
                if (selectedJobs.length === filteredJobs.length) {
                    setSelectedJobs([]);
                } else {
                    setSelectedJobs(filteredJobs.map(j => j.id));
                }
            };

            const bulkDeleteJobs = async () => {
                if (selectedJobs.length === 0) {
                    alert('Please select jobs to delete');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${selectedJobs.length} job(s)?`)) return;

                try {
                    await fetch(`${API_URL}/jobs/bulk-delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: selectedJobs })
                    });
                    setSelectedJobs([]);
                    loadData();
                    alert('‚úÖ Jobs deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting jobs');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Jobs</h1>
                                <p style={{color: 'var(--text-secondary)'}}>Manage your scaffolding projects with truck & driver info</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('job')}>
                                ‚ûï New Job
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <div style={{marginBottom: '24px'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 600, marginBottom: '12px'}}>Filter by Area:</h3>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                <button 
                                    className={`btn btn-sm ${selectedArea === 'all' ? 'btn-primary' : 'btn-secondary'}`}
                                    onClick={() => setSelectedArea('all')}
                                >
                                    All Areas ({jobs.length})
                                </button>
                                {areas.map(area => (
                                    <button 
                                        key={area}
                                        className={`btn btn-sm ${selectedArea === area ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setSelectedArea(area)}
                                    >
                                        {area} ({jobs.filter(j => j.area === area).length})
                                    </button>
                                ))}
                            </div>
                        </div>

                        {selectedJobs.length > 0 && (
                            <div className="bulk-actions-bar">
                                <div>
                                    <strong>{selectedJobs.length}</strong> job(s) selected
                                </div>
                                <button className="btn btn-danger btn-sm" onClick={bulkDeleteJobs}>
                                    üóëÔ∏è Delete Selected
                                </button>
                            </div>
                        )}

                        <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>
                            üî® {selectedArea === 'all' ? 'All Jobs' : `Jobs in ${selectedArea}`}
                        </h2>
                        
                        {filteredJobs.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th className="checkbox-cell">
                                            <input 
                                                type="checkbox"
                                                className="checkbox-input"
                                                checked={selectedJobs.length === filteredJobs.length && filteredJobs.length > 0}
                                                onChange={toggleSelectAll}
                                            />
                                        </th>
                                        <th>Job #</th>
                                        <th>Client</th>
                                        <th>Area</th>
                                        <th>Location</th>
                                        <th>Truck</th>
                                        <th>Fitter</th>
                                        <th>Start Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredJobs.map(job => (
                                        <tr key={job.id}>
                                            <td className="checkbox-cell">
                                                <input 
                                                    type="checkbox"
                                                    className="checkbox-input"
                                                    checked={selectedJobs.includes(job.id)}
                                                    onChange={() => toggleJobSelection(job.id)}
                                                />
                                            </td>
                                            <td><strong>{job.jobNumber}</strong></td>
                                            <td>{job.clientName}</td>
                                            <td><span className="area-tag">{job.area}</span></td>
                                            <td>{job.location}</td>
                                            <td>
                                                {job.truck ? (
                                                    <span className="info-badge">üöö {job.truck}</span>
                                                ) : (
                                                    <span style={{fontSize: '12px', color: 'var(--text-secondary)'}}>-</span>
                                                )}
                                            </td>
                                            <td>
                                                {job.driver ? (
                                                    <span className="info-badge">üë§ {job.driver}</span>
                                                ) : (
                                                    <span style={{fontSize: '12px', color: 'var(--text-secondary)'}}>-</span>
                                                )}
                                            </td>
                                            <td>{job.startDate ? new Date(job.startDate).toLocaleDateString('en-GB') : 'N/A'}</td>
                                            <td>
                                                <span className={`badge badge-${
                                                    job.status === 'active' ? 'success' : 
                                                    job.status === 'completed' ? 'info' : 'warning'
                                                }`}>
                                                    {job.status}
                                                </span>
                                            </td>
                                            <td>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('job', job)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteJob(job.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{textAlign: 'center', padding: '40px', color: 'var(--text-secondary)'}}>
                                {selectedArea === 'all' ? 'No jobs yet. Create your first job!' : `No jobs in ${selectedArea} area.`}
                            </p>
                        )}
                    </div>
                </>
            );
        }

        function SettingsView({ areas, setAreas, jobs, loadData }) {
            const [newAreaName, setNewAreaName] = useState('');
            const [editingArea, setEditingArea] = useState(null);
            const [editingName, setEditingName] = useState('');

            const addArea = () => {
                const trimmed = newAreaName.trim();
                if (!trimmed) {
                    alert('Please enter an area name');
                    return;
                }
                if (areas.includes(trimmed)) {
                    alert('This area already exists');
                    return;
                }
                setAreas([...areas, trimmed]);
                setNewAreaName('');
                alert(`‚úÖ Area "${trimmed}" added successfully`);
            };

            const startRename = (area) => {
                if (area === 'Unassigned') {
                    alert('Cannot rename "Unassigned" area');
                    return;
                }
                setEditingArea(area);
                setEditingName(area);
            };

            const saveRename = async () => {
                const trimmed = editingName.trim();
                if (!trimmed) {
                    alert('Please enter an area name');
                    return;
                }
                if (trimmed === editingArea) {
                    setEditingArea(null);
                    return;
                }
                if (areas.includes(trimmed)) {
                    alert('This area name already exists');
                    return;
                }

                // Update jobs with the old area name
                const jobsToUpdate = jobs.filter(j => j.area === editingArea);
                if (jobsToUpdate.length > 0) {
                    if (!confirm(`This will update ${jobsToUpdate.length} job(s) from "${editingArea}" to "${trimmed}". Continue?`)) {
                        setEditingArea(null);
                        return;
                    }

                    try {
                        // Update each job
                        for (const job of jobsToUpdate) {
                            await fetch(`${API_URL}/jobs/${job.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...job, area: trimmed })
                            });
                        }
                        await loadData();
                    } catch (error) {
                        alert('‚ùå Error updating jobs');
                        return;
                    }
                }

                // Update areas list
                const newAreas = areas.map(a => a === editingArea ? trimmed : a);
                setAreas(newAreas);
                setEditingArea(null);
                alert(`‚úÖ Area renamed from "${editingArea}" to "${trimmed}"`);
            };

            const deleteArea = (area) => {
                if (area === 'Unassigned') {
                    alert('Cannot delete "Unassigned" area');
                    return;
                }

                const jobCount = jobs.filter(j => j.area === area).length;
                
                if (jobCount > 0) {
                    if (!confirm(`This area has ${jobCount} job(s). These jobs will be moved to "Unassigned". Continue?`)) {
                        return;
                    }

                    // Move jobs to Unassigned
                    const jobsToUpdate = jobs.filter(j => j.area === area);
                    Promise.all(jobsToUpdate.map(job => 
                        fetch(`${API_URL}/jobs/${job.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...job, area: 'Unassigned' })
                        })
                    )).then(() => {
                        loadData();
                        const newAreas = areas.filter(a => a !== area);
                        setAreas(newAreas);
                        alert(`‚úÖ Area "${area}" deleted and ${jobCount} job(s) moved to Unassigned`);
                    }).catch(() => {
                        alert('‚ùå Error updating jobs');
                    });
                } else {
                    if (confirm(`Delete area "${area}"?`)) {
                        const newAreas = areas.filter(a => a !== area);
                        setAreas(newAreas);
                        alert(`‚úÖ Area "${area}" deleted`);
                    }
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div>
                            <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Settings</h1>
                            <p style={{color: 'var(--text-secondary)'}}>Manage areas and application settings</p>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>üìç Manage Areas</h2>
                        
                        <div style={{marginBottom: '32px'}}>
                            <h3 style={{fontSize: '16px', fontWeight: 600, marginBottom: '12px'}}>Add New Area</h3>
                            <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                                <input 
                                    type="text" 
                                    className="form-input" 
                                    style={{maxWidth: '300px'}}
                                    placeholder="Enter area name (e.g., Manchester)"
                                    value={newAreaName}
                                    onChange={(e) => setNewAreaName(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addArea()}
                                />
                                <button className="btn btn-primary" onClick={addArea}>
                                    ‚ûï Add Area
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3 style={{fontSize: '16px', fontWeight: 600, marginBottom: '12px'}}>
                                Existing Areas ({areas.length})
                            </h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Area Name</th>
                                        <th>Jobs Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {areas.map(area => (
                                        <tr key={area}>
                                            <td>
                                                {editingArea === area ? (
                                                    <input 
                                                        type="text"
                                                        className="form-input"
                                                        value={editingName}
                                                        onChange={(e) => setEditingName(e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && saveRename()}
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <strong>{area}</strong>
                                                )}
                                            </td>
                                            <td>
                                                <span className="info-badge">
                                                    {jobs.filter(j => j.area === area).length} jobs
                                                </span>
                                            </td>
                                            <td>
                                                {editingArea === area ? (
                                                    <div style={{display: 'flex', gap: '8px'}}>
                                                        <button className="btn btn-sm btn-success" onClick={saveRename}>
                                                            ‚úì Save
                                                        </button>
                                                        <button className="btn btn-sm btn-secondary" onClick={() => setEditingArea(null)}>
                                                            ‚úï Cancel
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div style={{display: 'flex', gap: '8px'}}>
                                                        <button 
                                                            className="btn btn-sm btn-secondary" 
                                                            onClick={() => startRename(area)}
                                                            disabled={area === 'Unassigned'}
                                                        >
                                                            ‚úèÔ∏è Rename
                                                        </button>
                                                        <button 
                                                            className="btn btn-sm btn-danger" 
                                                            onClick={() => deleteArea(area)}
                                                            disabled={area === 'Unassigned'}
                                                        >
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div style={{marginTop: '24px', padding: '16px', background: 'var(--bg-primary)', borderRadius: '12px'}}>
                            <h4 style={{fontSize: '14px', fontWeight: 600, marginBottom: '8px'}}>‚ÑπÔ∏è About Areas</h4>
                            <ul style={{fontSize: '13px', color: 'var(--text-secondary)', paddingLeft: '20px'}}>
                                <li>Areas help organize jobs by location</li>
                                <li>The "Unassigned" area cannot be deleted or renamed</li>
                                <li>Renaming an area updates all associated jobs</li>
                                <li>Deleting an area moves its jobs to "Unassigned"</li>
                                <li>Areas are stored locally in your browser</li>
                            </ul>
                        </div>
                    </div>
                </>
            );
        }

        function VehiclesView({ vehicles, openModal, loadData }) {
            const deleteVehicle = async (id) => {
                if (!confirm('Are you sure you want to delete this vehicle?')) return;
                try {
                    await fetch(`${API_URL}/vehicles/${id}`, { method: 'DELETE' });
                    loadData();
                    alert('‚úÖ Vehicle deleted successfully');
                } catch (error) {
                    alert('‚ùå Error deleting vehicle');
                }
            };

            const markActioned = async (vehicleId, field) => {
                const vehicle = vehicles.find(v => v.id === vehicleId);
                if (!vehicle) return;
                try {
                    await fetch(`${API_URL}/vehicles/${vehicleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...vehicle, [field]: true })
                    });
                    loadData();
                } catch (error) {
                    alert('‚ùå Error updating vehicle');
                }
            };

            return (
                <>
                    <div className="page-header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1 style={{fontSize: '32px', fontWeight: 700, marginBottom: '8px'}}>Vehicles</h1>
                                <p style={{color: 'var(--text-secondary)'}}>Track MOT, insurance, tax, tacho (30-day) and maintenance (1-week, 8-week cycle)</p>
                            </div>
                            <button className="btn btn-primary" onClick={() => openModal('vehicle')}>
                                ‚ûï Add Vehicle
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        <h2 style={{fontSize: '20px', fontWeight: 700, marginBottom: '24px'}}>üöó All Vehicles</h2>
                        {vehicles.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Registration</th>
                                        <th>Type</th>
                                        <th>Owner</th>
                                        <th>MOT Due</th>
                                        <th>Tax Due</th>
                                        <th>Insurance Due</th>
                                        {vehicles.some(v => v.vehicleType === 'truck') && <th>Tacho Due</th>}
                                        {vehicles.some(v => v.vehicleType === 'truck') && <th>Maintenance (8wk)</th>}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {vehicles.map(veh => (
                                        <tr key={veh.id}>
                                            <td><strong>{veh.registration}</strong></td>
                                            <td>{veh.vehicleType === 'truck' ? 'üöö Truck' : 'üöó ' + veh.vehicleType}</td>
                                            <td>{veh.ownerName}</td>
                                            <td>
                                                {veh.motDue ? new Date(veh.motDue).toLocaleDateString('en-GB') : 'N/A'}
                                                {veh.motDue && !veh.motActioned && (
                                                    <button 
                                                        className="btn btn-sm btn-success" 
                                                        style={{marginLeft: '8px', padding: '2px 8px', fontSize: '11px'}}
                                                        onClick={() => markActioned(veh.id, 'motActioned')}
                                                    >
                                                        ‚úì
                                                    </button>
                                                )}
                                            </td>
                                            <td>
                                                {new Date(veh.taxDue).toLocaleDateString('en-GB')}
                                                {!veh.taxActioned && (
                                                    <button 
                                                        className="btn btn-sm btn-success" 
                                                        style={{marginLeft: '8px', padding: '2px 8px', fontSize: '11px'}}
                                                        onClick={() => markActioned(veh.id, 'taxActioned')}
                                                    >
                                                        ‚úì
                                                    </button>
                                                )}
                                            </td>
                                            <td>
                                                {new Date(veh.insuranceDue).toLocaleDateString('en-GB')}
                                                {!veh.insuranceActioned && (
                                                    <button 
                                                        className="btn btn-sm btn-success" 
                                                        style={{marginLeft: '8px', padding: '2px 8px', fontSize: '11px'}}
                                                        onClick={() => markActioned(veh.id, 'insuranceActioned')}
                                                    >
                                                        ‚úì
                                                    </button>
                                                )}
                                            </td>
                                            {vehicles.some(v => v.vehicleType === 'truck') && (
                                                <td>
                                                    {veh.vehicleType === 'truck' && veh.tachoDue ? (
                                                        <>
                                                            {new Date(veh.tachoDue).toLocaleDateString('en-GB')}
                                                            {!veh.tachoActioned && (
                                                                <button 
                                                                    className="btn btn-sm btn-success" 
                                                                    style={{marginLeft: '8px', padding: '2px 8px', fontSize: '11px'}}
                                                                    onClick={() => markActioned(veh.id, 'tachoActioned')}
                                                                >
                                                                    ‚úì
                                                                </button>
                                                            )}
                                                        </>
                                                    ) : '-'}
                                                </td>
                                            )}
                                            {vehicles.some(v => v.vehicleType === 'truck') && (
                                                <td>
                                                    {veh.vehicleType === 'truck' && veh.maintenanceDue ? (
                                                        <>
                                                            {new Date(veh.maintenanceDue).toLocaleDateString('en-GB')}
                                                            {!veh.maintenanceActioned && (
                                                                <button 
                                                                    className="btn btn-sm btn-success" 
                                                                    style={{marginLeft: '8px', padding: '2px 8px', fontSize: '11px'}}
                                                                    onClick={() => markActioned(veh.id, 'maintenanceActioned')}
                                                                >
                                                                    ‚úì
                                                                </button>
                                                            )}
                                                        </>
                                                    ) : '-'}
                                                </td>
                                            )}
                                            <td>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => openModal('vehicle', veh)}>
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteVehicle(veh.id)}>
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <p style={{textAlign: 'center', padding: '40px', color: 'var(--text-secondary)'}}>
                                No vehicles yet. Add your first vehicle!
                            </p>
                        )}
                    </div>
                </>
            );
        }
        

        function Modal({ type, item, closeModal, loadData, jobs, inquiries, invoices, vehicles, areas }) {
            const handleSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                let payload = {};

                if (type === 'invoice') {
                    const items = [];
                    const itemCount = formData.getAll('item-description').length;
                    for (let i = 0; i < itemCount; i++) {
                        items.push({
                            description: formData.getAll('item-description')[i],
                            quantity: parseFloat(formData.getAll('item-quantity')[i]),
                            rate: parseFloat(formData.getAll('item-rate')[i])
                        });
                    }
                    const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                    const vat = subtotal * 0.20;
                    payload = {
                        invoiceNumber: formData.get('invoiceNumber'),
                        clientName: formData.get('clientName'),
                        clientAddress: formData.get('clientAddress'),
                        clientPhone: formData.get('clientPhone'),
                        date: formData.get('date'),
                        status: item?.status || 'pending',
                        items: JSON.stringify(items),
                        subtotal: subtotal,
                        vat: vat,
                        total: subtotal + vat,
                        notes: formData.get('notes')
                    };
                } else if (type === 'inquiry') {
                    payload = {
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        email: formData.get('email'),
                        location: formData.get('location'),
                        status: formData.get('status'),
                        date: formData.get('date'),
                        quoteAmount: parseFloat(formData.get('quoteAmount')) || null,
                        notes: formData.get('notes')
                    };
                } else if (type === 'job') {
                    const selectedArea = formData.get('area');
                    payload = {
                        jobNumber: formData.get('jobNumber'),
                        clientName: formData.get('clientName'),
                        location: formData.get('location'),
                        area: areas.includes(selectedArea) ? selectedArea : 'Unassigned',
                        jobType: formData.get('jobType'),
                        truck: formData.get('truck'),
                        driver: formData.get('driver'),
                        startDate: formData.get('startDate'),
                        endDate: formData.get('endDate'),
                        status: formData.get('status'),
                        value: parseFloat(formData.get('value')) || null,
                        notes: formData.get('notes')
                    };
                } else if (type === 'vehicle') {
                    const vehicleType = formData.get('vehicleType');
                    payload = {
                        registration: formData.get('registration').toUpperCase(),
                        vehicleType: vehicleType,
                        ownerName: formData.get('ownerName'),
                        insuranceName: formData.get('insuranceName'),
                        motDue: formData.get('motDue') || null,
                        taxDue: formData.get('taxDue'),
                        tachoDue: vehicleType === 'truck' ? formData.get('tachoDue') : null,
                        maintenanceDue: vehicleType === 'truck' ? formData.get('maintenanceDue') : null,
                        insuranceDue: formData.get('insuranceDue'),
                        motActioned: item?.motActioned || false,
                        taxActioned: item?.taxActioned || false,
                        tachoActioned: item?.tachoActioned || false,
                        insuranceActioned: item?.insuranceActioned || false,
                        maintenanceActioned: item?.maintenanceActioned || false
                    };
                }

                try {
                    const endpoint = type === 'invoice' ? 'invoices' : type === 'inquiry' ? 'inquiries' : type === 'job' ? 'jobs' : 'vehicles';
                    const url = item ? `${API_URL}/${endpoint}/${item.id}` : `${API_URL}/${endpoint}`;
                    const method = item ? 'PUT' : 'POST';
                    
                    await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    loadData();
                    closeModal();
                    alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} saved successfully!`);
                } catch (error) {
                    alert(`‚ùå Error saving ${type}`);
                }
            };

            const [invoiceItems, setInvoiceItems] = useState(
                item && type === 'invoice' && item.items ? 
                (typeof item.items === 'string' ? JSON.parse(item.items) : item.items) : 
                [{description: '', quantity: 1, rate: 0}]
            );

            const addInvoiceItem = () => {
                setInvoiceItems([...invoiceItems, {description: '', quantity: 1, rate: 0}]);
            };

            const removeInvoiceItem = (index) => {
                setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
            };

            const [vehicleType, setVehicleType] = useState(item?.vehicleType || 'car');

            // Get truck vehicles for dropdown
            const truckVehicles = vehicles?.filter(v => v.vehicleType === 'truck') || [];

            return (
                <div className="modal-overlay" onClick={closeModal}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 style={{fontSize: '20px', fontWeight: 700}}>
                                {item ? 'Edit' : 'New'} {type.charAt(0).toUpperCase() + type.slice(1)}
                            </h2>
                            <button onClick={closeModal} style={{background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer'}}>‚úï</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                {type === 'invoice' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Invoice Number *</label>
                                            <input type="text" name="invoiceNumber" className="form-input" defaultValue={item?.invoiceNumber || `INV-${Date.now()}`} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Name *</label>
                                            <input type="text" name="clientName" className="form-input" defaultValue={item?.clientName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Address</label>
                                            <input type="text" name="clientAddress" className="form-input" defaultValue={item?.clientAddress} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Phone</label>
                                            <input type="text" name="clientPhone" className="form-input" defaultValue={item?.clientPhone} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Date *</label>
                                            <input type="date" name="date" className="form-input" defaultValue={item?.date || new Date().toISOString().split('T')[0]} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Items</label>
                                            {invoiceItems.map((item, index) => (
                                                <div key={index} style={{display: 'flex', gap: '8px', marginBottom: '8px'}}>
                                                    <input type="text" name="item-description" className="form-input" placeholder="Description" defaultValue={item.description} required />
                                                    <input type="number" name="item-quantity" className="form-input" placeholder="Qty" defaultValue={item.quantity} style={{width: '80px'}} required />
                                                    <input type="number" name="item-rate" className="form-input" placeholder="Rate" defaultValue={item.rate} style={{width: '100px'}} step="0.01" required />
                                                    {invoiceItems.length > 1 && (
                                                        <button type="button" className="btn btn-danger btn-sm" onClick={() => removeInvoiceItem(index)}>üóëÔ∏è</button>
                                                    )}
                                                </div>
                                            ))}
                                            <button type="button" className="btn btn-secondary btn-sm" onClick={addInvoiceItem}>+ Add Item</button>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}

                                {type === 'inquiry' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Name *</label>
                                            <input type="text" name="name" className="form-input" defaultValue={item?.name} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Phone *</label>
                                            <input type="text" name="phone" className="form-input" defaultValue={item?.phone} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Email</label>
                                            <input type="email" name="email" className="form-input" defaultValue={item?.email} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Location *</label>
                                            <input type="text" name="location" className="form-input" defaultValue={item?.location} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Status</label>
                                            <select name="status" className="form-select" defaultValue={item?.status || 'new'}>
                                                <option value="new">New</option>
                                                <option value="contacted">Contacted</option>
                                                <option value="quoted">Quoted</option>
                                                <option value="won">Won</option>
                                                <option value="lost">Lost</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Date *</label>
                                            <input type="date" name="date" className="form-input" defaultValue={item?.date || new Date().toISOString().split('T')[0]} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Quote Amount</label>
                                            <input type="number" name="quoteAmount" className="form-input" defaultValue={item?.quoteAmount} step="0.01" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}

                                {type === 'job' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Job Number *</label>
                                            <input type="text" name="jobNumber" className="form-input" defaultValue={item?.jobNumber || `JOB-${Date.now()}`} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Client Name *</label>
                                            <input type="text" name="clientName" className="form-input" defaultValue={item?.clientName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Location *</label>
                                            <input type="text" name="location" className="form-input" defaultValue={item?.location} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Area *</label>
                                            <select name="area" className="form-select" defaultValue={item?.area || 'Unassigned'} required>
                                                {areas.map(area => (
                                                    <option key={area} value={area}>{area}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Job Type</label>
                                            <input type="text" name="jobType" className="form-input" defaultValue={item?.jobType} placeholder="e.g., Residential, Commercial" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">üöö Truck / Vehicle</label>
                                            {truckVehicles.length > 0 ? (
                                                <select name="truck" className="form-select" defaultValue={item?.truck || ''}>
                                                    <option value="">-- Select Truck --</option>
                                                    {truckVehicles.map(truck => (
                                                        <option key={truck.id} value={truck.registration}>
                                                            üöö {truck.registration} - {truck.ownerName}
                                                        </option>
                                                    ))}
                                                </select>
                                            ) : (
                                                <>
                                                    <input type="text" name="truck" className="form-input" defaultValue={item?.truck} placeholder="e.g., Registration or truck name" />
                                                    <small style={{color: 'var(--warning)', fontSize: '12px', marginTop: '4px', display: 'block'}}>
                                                        ‚ö†Ô∏è No trucks found in vehicles. Add trucks to vehicle database first.
                                                    </small>
                                                </>
                                            )}
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">üë§ Driver</label>
                                            <input type="text" name="driver" className="form-input" defaultValue={item?.driver} placeholder="e.g., Driver name" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Start Date</label>
                                            <input type="date" name="startDate" className="form-input" defaultValue={item?.startDate} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">End Date</label>
                                            <input type="date" name="endDate" className="form-input" defaultValue={item?.endDate} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Status</label>
                                            <select name="status" className="form-select" defaultValue={item?.status || 'pending'}>
                                                <option value="pending">Pending</option>
                                                <option value="active">Active</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Value (¬£)</label>
                                            <input type="number" name="value" className="form-input" defaultValue={item?.value} step="0.01" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Notes</label>
                                            <textarea name="notes" className="form-textarea" defaultValue={item?.notes}></textarea>
                                        </div>
                                    </>
                                )}

                                {type === 'vehicle' && (
                                    <>
                                        <div className="form-group">
                                            <label className="form-label">Registration *</label>
                                            <input type="text" name="registration" className="form-input" defaultValue={item?.registration} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Vehicle Type</label>
                                            <select name="vehicleType" className="form-select" value={vehicleType} onChange={(e) => setVehicleType(e.target.value)}>
                                                <option value="car">Car</option>
                                                <option value="van">Van</option>
                                                <option value="truck">Truck (HGV)</option>
                                            </select>
                                            <small style={{color: 'var(--text-secondary)', fontSize: '12px', marginTop: '4px', display: 'block'}}>
                                                Trucks get Tacho (30-day advance) & Maintenance (1-week advance, 8-week cycle)
                                            </small>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Owner Name *</label>
                                            <input type="text" name="ownerName" className="form-input" defaultValue={item?.ownerName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Insurance Company *</label>
                                            <input type="text" name="insuranceName" className="form-input" defaultValue={item?.insuranceName} required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">MOT Due (30-day advance)</label>
                                            <input type="date" name="motDue" className="form-input" defaultValue={item?.motDue} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Tax Due (14-day advance) *</label>
                                            <input type="date" name="taxDue" className="form-input" defaultValue={item?.taxDue} required />
                                        </div>
                                        {vehicleType === 'truck' && (
                                            <>
                                                <div className="form-group">
                                                    <label className="form-label">Tacho Due (30-day advance)</label>
                                                    <input type="date" name="tachoDue" className="form-input" defaultValue={item?.tachoDue} />
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Maintenance Due (1-week advance, auto-resets 8 weeks)</label>
                                                    <input type="date" name="maintenanceDue" className="form-input" defaultValue={item?.maintenanceDue} />
                                                    <small style={{color: 'var(--text-secondary)', fontSize: '12px', marginTop: '4px', display: 'block'}}>
                                                        ‚ÑπÔ∏è When marked "Done", automatically sets next date 8 weeks ahead
                                                    </small>
                                                </div>
                                            </>
                                        )}
                                        <div className="form-group">
                                            <label className="form-label">Insurance Due (60-day advance) *</label>
                                            <input type="date" name="insuranceDue" className="form-input" defaultValue={item?.insuranceDue} required />
                                        </div>
                                    </>
                                )}
                            </div>
                            <div style={{padding: '24px', borderTop: '1px solid var(--border)', display: 'flex', gap: '12px', justifyContent: 'flex-end'}}>
                                <button type="button" className="btn btn-secondary" onClick={closeModal}>Cancel</button>
                                <button type="submit" className="btn btn-primary">Save {type.charAt(0).toUpperCase() + type.slice(1)}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>